var a1=Object.create;var{getPrototypeOf:r1,defineProperty:L0,getOwnPropertyNames:t1}=Object;var e1=Object.prototype.hasOwnProperty;var $0=(z,X,$)=>{$=z!=null?a1(r1(z)):{};let Y=X||!z||!z.__esModule?L0($,"default",{value:z,enumerable:!0}):$;for(let q of t1(z))if(!e1.call(Y,q))L0(Y,q,{get:()=>z[q],enumerable:!0});return Y};var zz=(z,X)=>()=>(X||z((X={exports:{}}).exports,X),X.exports);var d0=(z,X)=>{for(var $ in X)L0(z,$,{get:X[$],enumerable:!0,configurable:!0,set:(Y)=>X[$]=()=>Y})};var Y0=(z,X)=>()=>(z&&(X=z(z=0)),X);var s0=((z)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(z,{get:(X,$)=>(typeof require!=="undefined"?require:X)[$]}):z)(function(z){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+z+'" is not supported')});function w(z){for(var X=arguments.length,$=Array(X>1?X-1:0),Y=1;Y<X;Y++)$[Y-1]=arguments[Y];var q=Wz[z],Z=q?typeof q=="function"?q.apply(null,$):q:"unknown error nr: "+z;throw Error("[Immer] "+Z)}function d(z){return!!z&&!!z[k]}function I(z){var X;return!!z&&(function($){if(!$||typeof $!="object")return!1;var Y=Object.getPrototypeOf($);if(Y===null)return!0;var q=Object.hasOwnProperty.call(Y,"constructor")&&Y.constructor;return q===Object||typeof q=="function"&&Function.toString.call(q)===Uz}(z)||Array.isArray(z)||!!z[z1]||!!((X=z.constructor)===null||X===void 0?void 0:X[z1])||_0(z)||k0(z))}function t(z,X,$){$===void 0&&($=!1),o(z)===0?($?Object.keys:P0)(z).forEach(function(Y){$&&typeof Y=="symbol"||X(Y,z[Y],z)}):z.forEach(function(Y,q){return X(q,Y,z)})}function o(z){var X=z[k];return X?X.i>3?X.i-4:X.i:Array.isArray(z)?1:_0(z)?2:k0(z)?3:0}function O0(z,X){return o(z)===2?z.has(X):Object.prototype.hasOwnProperty.call(z,X)}function Xz(z,X){return o(z)===2?z.get(X):z[X]}function X1(z,X,$){var Y=o(z);Y===2?z.set(X,$):Y===3?z.add($):z[X]=$}function $z(z,X){return z===X?z!==0||1/z==1/X:z!=z&&X!=X}function _0(z){return Kz&&z instanceof Map}function k0(z){return Jz&&z instanceof Set}function u(z){return z.o||z.t}function A0(z){if(Array.isArray(z))return Array.prototype.slice.call(z);var X=Fz(z);delete X[k];for(var $=P0(X),Y=0;Y<$.length;Y++){var q=$[Y],Z=X[q];Z.writable===!1&&(Z.writable=!0,Z.configurable=!0),(Z.get||Z.set)&&(X[q]={configurable:!0,writable:!0,enumerable:Z.enumerable,value:z[q]})}return Object.create(Object.getPrototypeOf(z),X)}function S0(z,X){return X===void 0&&(X=!1),M0(z)||d(z)||!I(z)||(o(z)>1&&(z.set=z.add=z.clear=z.delete=Yz),Object.freeze(z),X&&t(z,function($,Y){return S0(Y,!0)},!0)),z}function Yz(){w(2)}function M0(z){return z==null||typeof z!="object"||Object.isFrozen(z)}function P(z){var X=Nz[z];return X||w(18,z),X}function o0(){return s||w(0),s}function H0(z,X){X&&(P("Patches"),z.u=[],z.s=[],z.v=X)}function q0(z){D0(z),z.p.forEach(qz),z.p=null}function D0(z){z===s&&(s=z.l)}function c0(z){return s={p:[],l:s,h:z,m:!0,_:0}}function qz(z){var X=z[k];X.i===0||X.i===1?X.j():X.g=!0}function Q0(z,X){X._=X.p.length;var $=X.p[0],Y=z!==void 0&&z!==$;return X.h.O||P("ES5").S(X,z,Y),Y?($[k].P&&(q0(X),w(4)),I(z)&&(z=Z0(X,z),X.l||K0(X,z)),X.u&&P("Patches").M($[k].t,z,X.u,X.s)):z=Z0(X,$,[]),q0(X),X.u&&X.v(X.u,X.s),z!==$1?z:void 0}function Z0(z,X,$){if(M0(X))return X;var Y=X[k];if(!Y)return t(X,function(J,W){return n0(z,Y,X,J,W,$)},!0),X;if(Y.A!==z)return X;if(!Y.P)return K0(z,Y.t,!0),Y.t;if(!Y.I){Y.I=!0,Y.A._--;var q=Y.i===4||Y.i===5?Y.o=A0(Y.k):Y.o,Z=q,K=!1;Y.i===3&&(Z=new Set(q),q.clear(),K=!0),t(Z,function(J,W){return n0(z,Y,q,J,W,$,K)}),K0(z,q,!1),$&&z.u&&P("Patches").N(Y,$,z.u,z.s)}return Y.o}function n0(z,X,$,Y,q,Z,K){if(q===$&&w(5),d(q)){var J=Z0(z,q,Z&&X&&X.i!==3&&!O0(X.R,Y)?Z.concat(Y):void 0);if(X1($,Y,J),!d(J))return;z.m=!1}else K&&$.add(q);if(I(q)&&!M0(q)){if(!z.h.D&&z._<1)return;Z0(z,q),X&&X.A.l||K0(z,q)}}function K0(z,X,$){$===void 0&&($=!1),!z.l&&z.h.D&&z.m&&S0(X,$)}function T0(z,X){var $=z[k];return($?u($):z)[X]}function a0(z,X){if(X in z)for(var $=Object.getPrototypeOf(z);$;){var Y=Object.getOwnPropertyDescriptor($,X);if(Y)return Y;$=Object.getPrototypeOf($)}}function C0(z){z.P||(z.P=!0,z.l&&C0(z.l))}function j0(z){z.o||(z.o=A0(z.t))}function w0(z,X,$){var Y=_0(X)?P("MapSet").F(X,$):k0(X)?P("MapSet").T(X,$):z.O?function(q,Z){var K=Array.isArray(q),J={i:K?1:0,A:Z?Z.A:o0(),P:!1,I:!1,R:{},l:Z,t:q,k:null,o:null,j:null,C:!1},W=J,U=E0;K&&(W=[J],U=r);var F=Proxy.revocable(W,U),R=F.revoke,N=F.proxy;return J.k=N,J.j=R,N}(X,$):P("ES5").J(X,$);return($?$.A:o0()).p.push(Y),Y}function Zz(z){return d(z)||w(22,z),function X($){if(!I($))return $;var Y,q=$[k],Z=o($);if(q){if(!q.P&&(q.i<4||!P("ES5").K(q)))return q.t;q.I=!0,Y=r0($,Z),q.I=!1}else Y=r0($,Z);return t(Y,function(K,J){q&&Xz(q.t,K)===J||X1(Y,K,X(J))}),Z===3?new Set(Y):Y}(z)}function r0(z,X){switch(X){case 2:return new Map(z);case 3:return Array.from(z)}return A0(z)}var t0,s,b0,Kz,Jz,e0,$1,z1,k,Wz,Uz,P0,Fz,Nz,E0,r,Rz,A,Bz,S5,M5,b5,P5,y5,x5,Y1;var q1=Y0(()=>{b0=typeof Symbol!="undefined"&&typeof Symbol("x")=="symbol",Kz=typeof Map!="undefined",Jz=typeof Set!="undefined",e0=typeof Proxy!="undefined"&&Proxy.revocable!==void 0&&typeof Reflect!="undefined",$1=b0?Symbol.for("immer-nothing"):((t0={})["immer-nothing"]=!0,t0),z1=b0?Symbol.for("immer-draftable"):"__$immer_draftable",k=b0?Symbol.for("immer-state"):"__$immer_state",Wz={0:"Illegal state",1:"Immer drafts cannot have computed properties",2:"This object has been frozen and should not be mutated",3:function(z){return"Cannot use a proxy that has been revoked. Did you pass an object from inside an immer function to an async process? "+z},4:"An immer producer returned a new value *and* modified its draft. Either return a new value *or* modify the draft.",5:"Immer forbids circular references",6:"The first or second argument to `produce` must be a function",7:"The third argument to `produce` must be a function or undefined",8:"First argument to `createDraft` must be a plain object, an array, or an immerable object",9:"First argument to `finishDraft` must be a draft returned by `createDraft`",10:"The given draft is already finalized",11:"Object.defineProperty() cannot be used on an Immer draft",12:"Object.setPrototypeOf() cannot be used on an Immer draft",13:"Immer only supports deleting array indices",14:"Immer only supports setting array indices and the 'length' property",15:function(z){return"Cannot apply patch, path doesn't resolve: "+z},16:'Sets cannot have "replace" patches.',17:function(z){return"Unsupported patch operation: "+z},18:function(z){return"The plugin for '"+z+"' has not been loaded into Immer. To enable the plugin, import and call `enable"+z+"()` when initializing your application."},20:"Cannot use proxies if Proxy, Proxy.revocable or Reflect are not available",21:function(z){return"produce can only be called on things that are draftable: plain objects, arrays, Map, Set or classes that are marked with '[immerable]: true'. Got '"+z+"'"},22:function(z){return"'current' expects a draft, got: "+z},23:function(z){return"'original' expects a draft, got: "+z},24:"Patching reserved attributes like __proto__, prototype and constructor is not allowed"},Uz=""+Object.prototype.constructor,P0=typeof Reflect!="undefined"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(z){return Object.getOwnPropertyNames(z).concat(Object.getOwnPropertySymbols(z))}:Object.getOwnPropertyNames,Fz=Object.getOwnPropertyDescriptors||function(z){var X={};return P0(z).forEach(function($){X[$]=Object.getOwnPropertyDescriptor(z,$)}),X},Nz={},E0={get:function(z,X){if(X===k)return z;var $=u(z);if(!O0($,X))return function(q,Z,K){var J,W=a0(Z,K);return W?"value"in W?W.value:(J=W.get)===null||J===void 0?void 0:J.call(q.k):void 0}(z,$,X);var Y=$[X];return z.I||!I(Y)?Y:Y===T0(z.t,X)?(j0(z),z.o[X]=w0(z.A.h,Y,z)):Y},has:function(z,X){return X in u(z)},ownKeys:function(z){return Reflect.ownKeys(u(z))},set:function(z,X,$){var Y=a0(u(z),X);if(Y==null?void 0:Y.set)return Y.set.call(z.k,$),!0;if(!z.P){var q=T0(u(z),X),Z=q==null?void 0:q[k];if(Z&&Z.t===$)return z.o[X]=$,z.R[X]=!1,!0;if($z($,q)&&($!==void 0||O0(z.t,X)))return!0;j0(z),C0(z)}return z.o[X]===$&&($!==void 0||(X in z.o))||Number.isNaN($)&&Number.isNaN(z.o[X])||(z.o[X]=$,z.R[X]=!0),!0},deleteProperty:function(z,X){return T0(z.t,X)!==void 0||X in z.t?(z.R[X]=!1,j0(z),C0(z)):delete z.R[X],z.o&&delete z.o[X],!0},getOwnPropertyDescriptor:function(z,X){var $=u(z),Y=Reflect.getOwnPropertyDescriptor($,X);return Y?{writable:!0,configurable:z.i!==1||X!=="length",enumerable:Y.enumerable,value:$[X]}:Y},defineProperty:function(){w(11)},getPrototypeOf:function(z){return Object.getPrototypeOf(z.t)},setPrototypeOf:function(){w(12)}},r={};t(E0,function(z,X){r[z]=function(){return arguments[0]=arguments[0][0],X.apply(this,arguments)}}),r.deleteProperty=function(z,X){return isNaN(parseInt(X))&&w(13),r.set.call(this,z,X,void 0)},r.set=function(z,X,$){return X!=="length"&&isNaN(parseInt(X))&&w(14),E0.set.call(this,z[0],X,$,z[0])};Rz=function(){function z($){var Y=this;this.O=e0,this.D=!0,this.produce=function(q,Z,K){if(typeof q=="function"&&typeof Z!="function"){var J=Z;Z=q;var W=Y;return function(Q){var H=this;Q===void 0&&(Q=J);for(var T=arguments.length,B=Array(T>1?T-1:0),C=1;C<T;C++)B[C-1]=arguments[C];return W.produce(Q,function(E){var f;return(f=Z).call.apply(f,[H,E].concat(B))})}}var U;if(typeof Z!="function"&&w(6),K!==void 0&&typeof K!="function"&&w(7),I(q)){var F=c0(Y),R=w0(Y,q,void 0),N=!0;try{U=Z(R),N=!1}finally{N?q0(F):D0(F)}return typeof Promise!="undefined"&&U instanceof Promise?U.then(function(Q){return H0(F,K),Q0(Q,F)},function(Q){throw q0(F),Q}):(H0(F,K),Q0(U,F))}if(!q||typeof q!="object"){if((U=Z(q))===void 0&&(U=q),U===$1&&(U=void 0),Y.D&&S0(U,!0),K){var L=[],D=[];P("Patches").M(q,U,L,D),K(L,D)}return U}w(21,q)},this.produceWithPatches=function(q,Z){if(typeof q=="function")return function(U){for(var F=arguments.length,R=Array(F>1?F-1:0),N=1;N<F;N++)R[N-1]=arguments[N];return Y.produceWithPatches(U,function(L){return q.apply(void 0,[L].concat(R))})};var K,J,W=Y.produce(q,Z,function(U,F){K=U,J=F});return typeof Promise!="undefined"&&W instanceof Promise?W.then(function(U){return[U,K,J]}):[W,K,J]},typeof($==null?void 0:$.useProxies)=="boolean"&&this.setUseProxies($.useProxies),typeof($==null?void 0:$.autoFreeze)=="boolean"&&this.setAutoFreeze($.autoFreeze)}var X=z.prototype;return X.createDraft=function($){I($)||w(8),d($)&&($=Zz($));var Y=c0(this),q=w0(this,$,void 0);return q[k].C=!0,D0(Y),q},X.finishDraft=function($,Y){var q=$&&$[k];q&&q.C||w(9),q.I&&w(10);var Z=q.A;return H0(Z,Y),Q0(void 0,Z)},X.setAutoFreeze=function($){this.D=$},X.setUseProxies=function($){$&&!e0&&w(20),this.O=$},X.applyPatches=function($,Y){var q;for(q=Y.length-1;q>=0;q--){var Z=Y[q];if(Z.path.length===0&&Z.op==="replace"){$=Z.value;break}}q>-1&&(Y=Y.slice(q+1));var K=P("Patches").$;return d($)?K($,Y):this.produce($,function(J){return K(J,Y)})},z}(),A=new Rz,Bz=A.produce,S5=A.produceWithPatches.bind(A),M5=A.setAutoFreeze.bind(A),b5=A.setUseProxies.bind(A),P5=A.applyPatches.bind(A),y5=A.createDraft.bind(A),x5=A.finishDraft.bind(A),Y1=Bz});class K1{constructor(z){let X=Lz();if(this.c=1,this.s0=X(" "),this.s1=X(" "),this.s2=X(" "),this.s0-=X(z),this.s0<0)this.s0+=1;if(this.s1-=X(z),this.s1<0)this.s1+=1;if(this.s2-=X(z),this.s2<0)this.s2+=1}next(){let z=2091639*this.s0+this.c*0.00000000023283064365386963;return this.s0=this.s1,this.s1=this.s2,this.s2=z-(this.c=Math.trunc(z))}}function Lz(){let z=4022871197;return function($){let Y=$.toString();for(let q=0;q<Y.length;q++){z+=Y.charCodeAt(q);let Z=0.02519603282416938*z;z=Z>>>0,Z-=z,Z*=z,z=Z>>>0,Z-=z,z+=Z*4294967296}return(z>>>0)*0.00000000023283064365386963}}function Z1(z,X){return X.c=z.c,X.s0=z.s0,X.s1=z.s1,X.s2=z.s2,X}function Vz(z,X){let $=new K1(z),Y=$.next.bind($);if(X)Z1(X,$);return Y.state=()=>Z1($,{}),Y}class y0{constructor(z){this.state=z||{seed:"0"},this.used=!1}static seed(){return Date.now().toString(36).slice(-10)}isUsed(){return this.used}getState(){return this.state}_random(){this.used=!0;let z=this.state,X=z.prngstate?"":z.seed,$=Vz(X,z.prngstate),Y=$();return this.state={...z,prngstate:$.state()},Y}api(){let z=this._random.bind(this),X={D4:4,D6:6,D8:8,D10:10,D12:12,D20:20},$={};for(let q in X){let Z=X[q];$[q]=(K)=>{return K===void 0?Math.floor(z()*Z)+1:Array.from({length:K}).map(()=>Math.floor(z()*Z)+1)}}function Y(q=6,Z){return Z===void 0?Math.floor(z()*q)+1:Array.from({length:Z}).map(()=>Math.floor(z()*q)+1)}return{...$,Die:Y,Number:()=>{return z()},Shuffle:(q)=>{let Z=[...q],K=q.length,J=0,W=Array.from({length:K});while(K){let U=Math.trunc(K*z());W[J++]=Z[U],Z[U]=Z[--K]}return W},_private:this}}}var J1;var W1=Y0(()=>{J1={name:"random",noClient:({api:z})=>{return z._private.isUsed()},flush:({api:z})=>{return z._private.getState()},api:({data:z})=>{return new y0(z).api()},setup:({game:z})=>{let{seed:X}=z;if(X===void 0)X=y0.seed();return{seed:X}},playerView:()=>{return}}});var x0=zz((v5,N1)=>{var Hz="[object Object]";function Qz(z){var X=!1;if(z!=null&&typeof z.toString!="function")try{X=!!(z+"")}catch($){}return X}function Tz(z,X){return function($){return z(X($))}}var jz=Function.prototype,U1=Object.prototype,F1=jz.toString,Oz=U1.hasOwnProperty,Dz=F1.call(Object),Cz=U1.toString,wz=Tz(Object.getPrototypeOf,Object);function Ez(z){return!!z&&typeof z=="object"}function _z(z){if(!Ez(z)||Cz.call(z)!=Hz||Qz(z))return!1;var X=wz(z);if(X===null)return!0;var $=Oz.call(X,"constructor")&&X.constructor;return typeof $=="function"&&$ instanceof $&&F1.call($)==Dz}N1.exports=_z});class B1{constructor(z,X,$){this.flow=z,this.playerID=$,this.dispatch=[],this.initialTurn=X.turn,this.updateTurnContext(X,void 0),this.maxEndedTurnsPerAction=X.numPlayers*100}api(){let z={_private:this};for(let X of this.flow.eventNames)z[X]=(...$)=>{this.dispatch.push({type:X,args:$,phase:this.currentPhase,turn:this.currentTurn,calledFrom:this.currentMethod,error:new Error("Events Plugin Error")})};return z}isUsed(){return this.dispatch.length>0}updateTurnContext(z,X){this.currentPhase=z.phase,this.currentTurn=z.turn,this.currentMethod=X}unsetCurrentMethod(){this.currentMethod=void 0}update(z){let X=z,$=({stack:Y},q)=>({...X,plugins:{...X.plugins,events:{...X.plugins.events,data:{error:q+`
`+Y}}}});z:for(let Y=0;Y<this.dispatch.length;Y++){let q=this.dispatch[Y],Z=q.turn!==z.ctx.turn;if(this.currentTurn-this.initialTurn>=this.maxEndedTurnsPerAction)return $(q.error,h.MaxTurnEndings);if(q.calledFrom===void 0)return $(q.error,h.CalledOutsideHook);if(z.ctx.gameover)break z;switch(q.type){case"endStage":case"setStage":case"setActivePlayers":{switch(q.calledFrom){case S.TURN_ON_END:case S.PHASE_ON_END:return $(q.error,h.StageEventInOnEnd);case S.PHASE_ON_BEGIN:return $(q.error,h.StageEventInPhaseBegin);case S.TURN_ON_BEGIN:if(q.type==="setActivePlayers")break;return $(q.error,h.StageEventInTurnBegin)}if(Z)continue z;break}case"endTurn":{if(q.calledFrom===S.TURN_ON_END||q.calledFrom===S.PHASE_ON_END)return $(q.error,h.EndTurnInOnEnd);if(Z)continue z;break}case"endPhase":case"setPhase":{if(q.calledFrom===S.PHASE_ON_END)return $(q.error,h.PhaseEventInOnEnd);if(q.phase!==z.ctx.phase)continue z;break}}let J=Az(q.type,q.args,this.playerID);z=this.flow.processEvent(z,J)}return z}}function L1(z){if(z===void 0||z===null||typeof z==="boolean"||typeof z==="number"||typeof z==="string")return!0;if(!R1.default(z)&&!Array.isArray(z))return!1;for(let X in z)if(!L1(z[X]))return!1;return!0}var R1,kz="GAME_EVENT",Az=(z,X,$,Y)=>({type:kz,payload:{type:z,args:X,playerID:$,credentials:Y},automatic:!0}),J0="INVALID_MOVE",Sz,S,h,Mz,bz,Pz,yz,u5,V1,c,H1;var Q1=Y0(()=>{q1();W1();R1=$0(x0(),1),Sz={name:"plugin-immer",fnWrap:(z)=>(X,...$)=>{let Y=!1,q=Y1(X.G,(Z)=>{let K=z({...X,G:Z},...$);if(K===J0){Y=!0;return}return K});if(Y)return J0;return q}};(function(z){z.MOVE="MOVE",z.GAME_ON_END="GAME_ON_END",z.PHASE_ON_BEGIN="PHASE_ON_BEGIN",z.PHASE_ON_END="PHASE_ON_END",z.TURN_ON_BEGIN="TURN_ON_BEGIN",z.TURN_ON_MOVE="TURN_ON_MOVE",z.TURN_ON_END="TURN_ON_END"})(S||(S={}));(function(z){z.CalledOutsideHook="Events must be called from moves or the `onBegin`, `onEnd`, and `onMove` hooks.\nThis error probably means you called an event from other game code, like an `endIf` trigger or one of the `turn.order` methods.",z.EndTurnInOnEnd="`endTurn` is disallowed in `onEnd` hooks — the turn is already ending.",z.MaxTurnEndings=`Maximum number of turn endings exceeded for this update.
This likely means game code is triggering an infinite loop.`,z.PhaseEventInOnEnd="`setPhase` & `endPhase` are disallowed in a phase’s `onEnd` hook — the phase is already ending.\nIf you’re trying to dynamically choose the next phase when a phase ends, use the phase’s `next` trigger.",z.StageEventInOnEnd="`setStage`, `endStage` & `setActivePlayers` are disallowed in `onEnd` hooks.",z.StageEventInPhaseBegin="`setStage`, `endStage` & `setActivePlayers` are disallowed in a phase’s `onBegin` hook.\nUse `setActivePlayers` in a `turn.onBegin` hook or declare stages with `turn.activePlayers` instead.",z.StageEventInTurnBegin="`setStage` & `endStage` are disallowed in `turn.onBegin`.\nUse `setActivePlayers` or declare stages with `turn.activePlayers` instead."})(h||(h={}));Mz={name:"events",noClient:({api:z})=>z._private.isUsed(),isInvalid:({data:z})=>z.error||!1,fnWrap:(z,X)=>($,...Y)=>{let q=$.events;if(q)q._private.updateTurnContext($.ctx,X);let Z=z($,...Y);if(q)q._private.unsetCurrentMethod();return Z},dangerouslyFlushRawState:({state:z,api:X})=>X._private.update(z),api:({game:z,ctx:X,playerID:$})=>new B1(z.flow,X,$).api()},bz={name:"log",flush:()=>({}),api:({data:z})=>{return{setMetadata:(X)=>{z.metadata=X}}},setup:()=>({})};Pz={name:"plugin-serializable",fnWrap:(z)=>(X,...$)=>{let Y=z(X,...$);if(!L1(Y))throw new Error(`Move state is not JSON-serialiazable.
See https://boardgame.io/documentation/#/?id=state for more information.`);return Y}},yz=[Sz,J1,bz,Pz],u5=[...yz,Mz],V1={DEFAULT:{first:({ctx:z})=>z.turn===0?z.playOrderPos:(z.playOrderPos+1)%z.playOrder.length,next:({ctx:z})=>(z.playOrderPos+1)%z.playOrder.length},RESET:{first:()=>0,next:({ctx:z})=>(z.playOrderPos+1)%z.playOrder.length},CONTINUE:{first:({ctx:z})=>z.playOrderPos,next:({ctx:z})=>(z.playOrderPos+1)%z.playOrder.length},ONCE:{first:()=>0,next:({ctx:z})=>{if(z.playOrderPos<z.playOrder.length-1)return z.playOrderPos+1}},CUSTOM:(z)=>({playOrder:()=>z,first:()=>0,next:({ctx:X})=>(X.playOrderPos+1)%X.playOrder.length}),CUSTOM_FROM:(z)=>({playOrder:({G:X})=>X[z],first:()=>0,next:({ctx:X})=>(X.playOrderPos+1)%X.playOrder.length})},c={NULL:null},H1={ALL:{all:c.NULL},ALL_ONCE:{all:c.NULL,minMoves:1,maxMoves:1},OTHERS:{others:c.NULL},OTHERS_ONCE:{others:c.NULL,minMoves:1,maxMoves:1}}});var h0={};d0(h0,{TurnOrder:()=>V1,Stage:()=>c,PlayerView:()=>xz,INVALID_MOVE:()=>J0,GameMethod:()=>S,ActivePlayers:()=>H1});var G5,xz;var m0=Y0(()=>{Q1();G5=$0(x0(),1),xz={STRIP_SECRETS:({G:z,playerID:X})=>{let $={...z};if($.secret!==void 0)delete $.secret;if($.players)$.players=X?{[X]:$.players[X]}:{};return $}}});class V0{constructor(z,X={}){this.rootEl=z,this.size={w:z.clientWidth,h:z.clientHeight};let{Application:$,Container:Y,Renderer:q}=PIXI;this.app=new $({width:this.size.w,height:this.size.h,antialias:!0,backgroundAlpha:1,backgroundColor:724242,view:function(){let Z=document.createElement("canvas");return z.appendChild(Z),Z}()}),this.gridLayer=new Y,this.highlightLayer=new Y,this.tokenLayer=new Y,this.app.stage.addChild(this.gridLayer,this.highlightLayer,this.tokenLayer),this.zoom=1,this.cellSize=32,this._setupInteractions()}_setupInteractions(){let z=!1,X={x:0,y:0};this.app.view.addEventListener("mousedown",($)=>{if($.button===2)z=!0,X={x:$.clientX,y:$.clientY}}),this.app.view.addEventListener("mousemove",($)=>{if(!z)return;let Y=$.clientX-X.x,q=$.clientY-X.y;X={x:$.clientX,y:$.clientY},this.app.stage.x+=Y,this.app.stage.y+=q}),this.app.view.addEventListener("mouseup",()=>{z=!1}),this.app.view.addEventListener("mouseleave",()=>{z=!1}),this.app.view.addEventListener("contextmenu",($)=>$.preventDefault()),this.app.view.addEventListener("wheel",($)=>{let Y=Math.sign($.deltaY),q=Math.min(2.5,Math.max(0.5,this.zoom*(Y>0?0.9:1.1)));this.zoom=q,this.app.stage.scale.set(this.zoom)},{passive:!0}),window.addEventListener("resize",()=>this._resize())}_resize(){let z=this.rootEl.clientWidth,X=this.rootEl.clientHeight;this.app.renderer.resize(z,X)}drawGrid(z){let{Graphics:X}=PIXI,$=new X;$.clear(),$.lineStyle({width:1,color:1711397,alpha:1});let Y=this.cellSize;for(let q=0;q<=z.w;q++)$.moveTo(q*Y,0),$.lineTo(q*Y,z.h*Y);for(let q=0;q<=z.h;q++)$.moveTo(0,q*Y),$.lineTo(z.w*Y,q*Y);this.gridLayer.removeChildren(),this.gridLayer.addChild($)}drawTokens(z){let{Graphics:X,Text:$}=PIXI;this.tokenLayer.removeChildren();let Y=this.cellSize;for(let[q,Z]of Object.entries(z.board.positions||{})){let K=new X,J=z.actors&&z.actors[q]&&z.actors[q].team==="B"?14051946:6989526;K.beginFill(J),K.drawCircle(0,0,Y*0.4),K.endFill(),K.x=(Z.x+0.5)*Y,K.y=(Z.y+0.5)*Y,K.eventMode="static",K.cursor="pointer",K.name=`token:${q}`;let W=new $(q,{fill:724242,fontSize:12});W.anchor.set(0.5),W.y=-2,K.addChild(W),this.tokenLayer.addChild(K)}}drawPathHighlight(z,X=4950527){let{Graphics:$}=PIXI;if(this.highlightLayer.removeChildren(),!z||z.length<2)return;let Y=new $;Y.lineStyle({width:2,color:X,alpha:0.9});let q=this.cellSize;Y.moveTo((z[0].x+0.5)*q,(z[0].y+0.5)*q);for(let Z=1;Z<z.length;Z++)Y.lineTo((z[Z].x+0.5)*q,(z[Z].y+0.5)*q);this.highlightLayer.addChild(Y)}drawTemplateCells(z,X,$=8050298){let{Graphics:Y}=PIXI;if(this.highlightLayer.removeChildren(),!z||z.size===0)return;let q=new Y,Z=this.cellSize;q.beginFill($,0.25),q.lineStyle({width:1,color:$,alpha:0.8});for(let K of z){let[J,W]=String(K).split(","),U=Number(J),F=Number(W);q.drawRect(U*Z,F*Z,Z,Z)}q.endFill(),this.highlightLayer.addChild(q)}worldToCell(z){let X=1/this.cellSize,$=Math.floor((z.x/this.zoom-this.app.stage.x/this.zoom)*X),Y=Math.floor((z.y/this.zoom-this.app.stage.y/this.zoom)*X);return{x:$,y:Y}}}import{Client as X5}from"https://esm.sh/boardgame.io@0.50.2/client";import{SocketIO as $5}from"https://esm.sh/boardgame.io@0.50.2/multiplayer";var G;try{G=(await Promise.resolve().then(() => (m0(),h0))).INVALID_MOVE}catch(z){G=(await import("https://esm.sh/boardgame.io@0.50.2/core")).INVALID_MOVE}var hz=(z,X)=>{let $=z+X>>>0;return{nextFloat:()=>{$+=1831565813;let q=Math.imul($^$>>>15,1|$);return q^=q+Math.imul(q^q>>>7,61|q),((q^q>>>14)>>>0)/4294967296},cursor:X+1}},l=(z,X)=>{let{nextFloat:$}=hz(z.rng.seed,z.rng.cursor),Y,q,Z=0;if(X==="d20")Y=Math.floor($()*20)+1,q=[Y],Z=1;else if(X==="d6")Y=Math.floor($()*6)+1,q=[Y],Z=1;else if(X&&X.kind==="sum")q=X.terms.map((J)=>{if(typeof J==="number")return J;if(J==="d20")return Z+=1,Math.floor($()*20)+1;if(J==="d6")return Z+=1,Math.floor($()*6)+1;return 0}),Y=q.reduce((J,W)=>J+W,0);else Y=1,q=[1],Z=0;let K=[{type:"set",path:"rng.cursor",value:z.rng.cursor+Z},{type:"log",value:{type:"roll",msg:`Rolled ${typeof X==="string"?X:X&&X.kind?X.kind:"unknown"}`,data:{spec:X,result:Y,parts:q},rng:{seed:z.rng.seed,idx:z.rng.cursor}}}];return{result:Y,parts:q,patches:K}};var e=(z,X)=>X.split(".").reduce(($,Y)=>$?$[Y]:void 0,z),i=(z,X,$)=>{let Y=X.split("."),q=z;for(let Z=0;Z<Y.length-1;Z++){let K=Y[Z];q[K]=q[K]??{},q=q[K]}q[Y[Y.length-1]]=$},m=(z,X=[])=>{console.log("Applying patches:",JSON.stringify(X,null,2));for(let $ of X){if(!$||typeof $!=="object"){console.warn("Skipping invalid patch:",$);continue}switch($.type){case"set":{if($.value===void 0){let Y=$.path.split("."),q=z;for(let Z=0;Z<Y.length-1;Z++){let K=Y[Z];q[K]=q[K]??{},q=q[K]}delete q[Y[Y.length-1]]}else i(z,$.path,$.value);break}case"inc":{let Y=e(z,$.path)||0;i(z,$.path,Y+$.value);break}case"merge":{let Y=e(z,$.path)??{};i(z,$.path,{...Y,...$.value});break}case"add":{let Y=e(z,$.path)||[];i(z,$.path,[...Y,$.value]);break}case"remove":{let Y=e(z,$.path)||[];i(z,$.path,Y.filter((q)=>q!==$.value));break}case"log":{let Y=e(z,"log"),q=Array.isArray(Y)?Y:[],Z=Object.assign({ts:(z._ts||0)+1},$.value);q.push(Z),i(z,"log",q),i(z,"_ts",(z._ts||0)+1);break}}}};var T1=(z,X,$,Y)=>{let q=z.actors&&z.actors[X]||{},Z=q.hp||{current:1,max:1,temp:0},K={hp:Z.current??0,temp:Z.temp??0},J=(Z.current||0)<=Math.floor((Z.max||1)/2),W=q&&q.death&&q.death.stabilized,U=!!(q&&q.flags&&q.flags.dying),F=$,R=q.immune&&Y&&q.immune[Y],N=q.resist&&Y&&q.resist[Y]||0,L=q.vulnerable&&Y&&q.vulnerable[Y]||0;if(R)F=0;F=Math.max(0,F+L-N);let D=0,Q=Z.temp||0,H=F;if(Q>0&&H>0)D=Math.min(Q,H),Q-=D,H-=D;let T=Math.max(0,(Z.current||0)-H),B=[];B.push({type:"set",path:`actors.${X}.hp.temp`,value:Q}),B.push({type:"set",path:`actors.${X}.hp.current`,value:T});let C=Z.max||1,E=T<=Math.floor(C/2);if(B.push({type:"merge",path:`actors.${X}`,value:{bloodied:E}}),B.push({type:"merge",path:`actors.${X}.flags`,value:{bloodied:E}}),!J&&E)B.push({type:"log",value:{type:"bloodied-enter",msg:`${X} becomes bloodied`,data:{max:C,hp:T}}});else if(J&&!E)B.push({type:"log",value:{type:"bloodied-exit",msg:`${X} is no longer bloodied`,data:{max:C,hp:T}}});if(T<=0)B.push({type:"merge",path:`actors.${X}.flags`,value:{dying:!0}}),B.push({type:"log",value:{type:"drop-to-0",msg:`${X} drops to 0 or fewer HP`,data:{before:K,after:{hp:T,temp:Q}}}});let f=-Math.floor(C/2);if((Z.current||0)-H<=f){B.push({type:"merge",path:`actors.${X}.flags`,value:{dead:!0,dying:!1}}),B.push({type:"log",value:{type:"die",msg:`${X} dies (instant death)`,data:{threshold:f}}});let c1=Object.entries(z.effects||{}).filter(([g,B0])=>B0&&(B0.target===X||B0.source===X)).map(([g])=>g);for(let g of c1)B.push({type:"set",path:`effects.${g}`,value:void 0});B.push({type:"set",path:`actors.${X}.conditions`,value:[]}),B.push({type:"set",path:"prompts.current",value:null});let n1=(z.queue||[]).filter((g)=>!(Array.isArray(g.eligible)&&g.eligible.includes(X)));B.push({type:"set",path:"queue",value:n1})}if(W&&H>0){if(B.push({type:"set",path:`actors.${X}.death.stabilized`,value:!1}),T<=0)B.push({type:"merge",path:`actors.${X}.flags`,value:{dying:!0}})}if(U&&H>0)B.push({type:"inc",path:`actors.${X}.death.failures`,value:1}),B.push({type:"log",value:{type:"death-save",msg:`${X} accrues a failed death save from damage`,data:{added:1}}});return B.push({type:"log",value:{type:"damage-apply",msg:`Damage applied to ${X}`,data:{before:K,after:{hp:T,temp:Q},resist:N,vuln:L,immune:!!R,final:H}}}),{final:H,consumedTemp:D,resisted:N,vulnerable:L,patches:B}};var W0=(z,X)=>{let $=[],Y=z.effects&&z.effects[X];if(!Y)return $;let q=z.actors&&z.actors[Y.target];if(q&&Array.isArray(q.conditions)){let Z=q.conditions.filter((K)=>K!==X);$.push({type:"set",path:`actors.${Y.target}.conditions`,value:Z})}return $.push({type:"set",path:`effects.${X}`,value:void 0}),$.push({type:"log",value:{type:"condition-remove",msg:`${Y.conditionId} removed from ${Y.target}`,data:{instanceId:X}}}),$},mz=(z,X)=>{let $=z.effects&&z.effects[X];if(!$)return{success:!1,patches:[]};let Y=[],q=l(z,"d20");Y.push(...q.patches||[]);let Z=q.result>=10;if(Y.push({type:"log",value:{type:"save-roll",msg:`Save vs ${$.conditionId}`,data:{target:$.target,instanceId:X,d20:q.result,success:Z,rng:{seed:z.rng.seed,idx:z.rng.cursor}}}}),Y.push({type:"log",value:{type:Z?"save-success":"save-fail",msg:Z?"Save succeeds":"Save fails",data:{instanceId:X}}}),Z)Y.push(...W0(z,X));return{success:Z,patches:Y}},vz=(z,X)=>{let $=[];for(let[Y,q]of Object.entries(z.effects||{}))if(q.target===X&&q.conditionId==="ongoing-damage"){let Z=q.data&&q.data.amount||0,K=q.data&&q.data.type;$.push({type:"log",value:{type:"ongoing-apply",msg:`Ongoing ${Z}${K?" "+K:""} to ${X}`,data:{instanceId:Y}}});let J=T1(z,X,Z,K);$.push(...J.patches)}return $},j1=(z,X)=>{let $=[];$.push(...vz(z,X));for(let[Y,q]of Object.entries(z.effects||{}))if(q.duration==="startOfSourceNext"&&q.source===X)$.push(...W0(z,Y)),$.push({type:"log",value:{type:"effect-expire",msg:`Effect ${Y} expired at start of source's turn`,data:{instanceId:Y}}});return $},O1=(z,X)=>{let $=[];for(let[Y,q]of Object.entries(z.effects||{}))if(q.target===X&&q.duration==="saveEnds"){let Z=mz(z,Y);$.push(...Z.patches)}for(let[Y,q]of Object.entries(z.effects||{}))if(q.duration==="endOfSourceNext"&&q.source===X)$.push(...W0(z,Y)),$.push({type:"log",value:{type:"effect-expire",msg:`Effect ${Y} expired at end of source's turn`,data:{instanceId:Y}}});for(let[Y,q]of Object.entries(z.effects||{}))if(q.target===X&&q.data&&q.data.sustain){if((q.meta&&q.meta.sustainedRound)!==z.round)$.push(...W0(z,Y)),$.push({type:"log",value:{type:"effect-expire",msg:`Effect ${Y} expired (not sustained)`,data:{instanceId:Y}}})}return $},D1=(z,X)=>{let $={standard:1,move:1,minor:1};for(let Y of Object.values(z.effects||{})){if(Y.target!==X)continue;if(Y.conditionId==="dazed")$={standard:Math.min($.standard,1),move:Math.min($.move,0),minor:Math.min($.minor,0)};if(Y.conditionId==="stunned")$={standard:0,move:0,minor:0}}return $},v0=(z,X)=>{let $={speed0:!1,slowCap2:!1,cannotShift:!1,weakened:!1,grantCA:!1,hasCA:!1};for(let Y of Object.values(z.effects||{})){if(Y.target!==X)continue;if(Y.conditionId==="immobilized")$.speed0=!0;if(Y.conditionId==="restrained")$.speed0=!0,$.cannotShift=!0,$.grantCA=!0;if(Y.conditionId==="slowed")$.slowCap2=!0;if(Y.conditionId==="weakened")$.weakened=!0;if(Y.conditionId==="blinded")$.grantCA=!0;if(Y.conditionId==="prone")$.grantCA=!0;if(Y.conditionId==="dazed"||Y.conditionId==="stunned")$.grantCA=!0;if(Y.conditionId==="invisible")$.hasCA=!0}return $};var U0=(z,X)=>{let $=z.actors&&z.actors[X]||{},Y=$.hp||{current:0,max:1,temp:0},q=$.surges||{remaining:0,value:Math.max(1,Math.floor((Y.max||1)/4))},Z=$.death||{failures:0,stabilized:!1},K=$.flags||{};return{actor:$,hp:Y,surges:q,death:Z,flags:K}},F0=(z,X,{multiplier:$=1,bonus:Y=0}={})=>{let{hp:q,surges:Z}=U0(z,X),K=[],J=0;if((Z.remaining||0)>0)J=(Z.value||0)*$+Y,K.push({type:"inc",path:`actors.${X}.surges.remaining`,value:-1}),K.push({type:"log",value:{type:"surge-spend",msg:`${X} spends a surge`,data:{actorId:X,value:Z.value,multiplier:$,bonus:Y}}});else J=0;return{healed:J,patches:K}},f0=(z,X,$=0,{requiresSurge:Y=!1,allowOverflow:q=!0}={})=>{let{hp:Z,surges:K,death:J}=U0(z,X),W=[],U=Math.max(0,$),F=!1;if(Y){if((K.remaining||0)>0){let H=F0(z,X,{});W.push(...H.patches),U+=H.healed,F=!0}}let R={hp:Z.current||0,temp:Z.temp||0},N=Z.current||0;if(N<0)N=0;let L=N+U,D=Z.max||1;if(!q)L=Math.min(L,D);if(Y&&(K.remaining||0)===0)L=Math.max(L,1);if(W.push({type:"set",path:`actors.${X}.hp.current`,value:L}),L>0)W.push({type:"merge",path:`actors.${X}.flags`,value:{dying:!1,dead:!1}}),W.push({type:"set",path:`actors.${X}.death.failures`,value:0}),W.push({type:"set",path:`actors.${X}.death.stabilized`,value:!1}),W.push({type:"log",value:{type:"revive",msg:`${X} revived above 0 HP`,data:{hp:L}}});let Q=L<=Math.floor(D/2);return W.push({type:"merge",path:`actors.${X}`,value:{bloodied:Q}}),W.push({type:"merge",path:`actors.${X}.flags`,value:{bloodied:Q}}),W.push({type:"log",value:{type:"heal-apply",msg:`${X} healed`,data:{actorId:X,before:R,after:{hp:L,temp:Z.temp||0},requiresSurge:Y,usedSurge:F}}}),{patches:W}};var g0=(z,X)=>{let $=[],{surges:Y}=U0(z,X);if(z.actors&&z.actors[X]&&z.actors[X].flags&&z.actors[X].flags.usedSecondWind||!1)return $.push({type:"log",value:{type:"second-wind",msg:`${X} cannot Second Wind (already used)`,data:{actorId:X}}}),$;if((Y.remaining||0)>0){let Z=F0(z,X,{});$.push(...Z.patches);let K=f0(z,X,Z.healed,{requiresSurge:!1,allowOverflow:!1});$.push(...K.patches);let J=z.actors[X]&&z.actors[X].flags||{};$.push({type:"set",path:`actors.${X}.flags`,value:{...J,defenseBonus:2,usedSecondWind:!0}}),$.push({type:"log",value:{type:"second-wind",msg:`${X} uses Second Wind (+2 defenses)`,data:{actorId:X}}})}else $.push({type:"log",value:{type:"second-wind",msg:`${X} cannot Second Wind (no surges)`,data:{actorId:X}}});return $},C1=(z,X,$={})=>{let Y=[],{death:q,surges:Z}=U0(z,X);if(!(z.actors&&z.actors[X]&&z.actors[X].flags&&z.actors[X].flags.dying&&!q.stabilized))return{patches:Y};let K;if($&&typeof $.forceD20==="number")K={result:$.forceD20,patches:[]};else K=l(z,"d20"),Y.push(...K.patches||[]);let J="no-change",W=q.failures||0;if(K.result<=9)J="fail",W+=1,Y.push({type:"inc",path:`actors.${X}.death.failures`,value:1});else if(K.result>=20)if((Z.remaining||0)>0){J="surge";let U=F0(z,X,{});Y.push(...U.patches);let F=f0(z,X,U.healed,{requiresSurge:!1,allowOverflow:!1});Y.push(...F.patches)}else J="no-change";if(Y.push({type:"log",value:{type:"death-save",msg:`${X} death save (${K.result})`,data:{d20:K.result,outcome:J,failures:W},rng:{seed:z.rng.seed,idx:z.rng.cursor}}}),W>=3)Y.push({type:"merge",path:`actors.${X}`,value:{flags:{...z.actors[X]&&z.actors[X].flags||{},dead:!0,dying:!1}}}),Y.push({type:"log",value:{type:"die",msg:`${X} dies`,data:{actorId:X}}});return{patches:Y}};var w1=(z,X)=>Math.max(Math.abs(z.x-X.x),Math.abs(z.y-X.y));var u0=(z)=>[{x:z.x+1,y:z.y},{x:z.x-1,y:z.y},{x:z.x,y:z.y+1},{x:z.x,y:z.y-1},{x:z.x+1,y:z.y+1},{x:z.x-1,y:z.y+1},{x:z.x+1,y:z.y-1},{x:z.x-1,y:z.y-1}],M=({x:z,y:X})=>`${z},${X}`;var z0=({x:z,y:X},{w:$,h:Y})=>z>=0&&X>=0&&z<$&&X<Y;var E1=(z,X)=>{let $=M(X);for(let[Y,q]of Object.entries(z.board.positions||{}))if(M(q)===$)return Y;return null},_1=(z,X,$,Y={})=>{let q=Y.threatRange??1,Z=new Set,K=[];if(!Array.isArray($)||$.length<2)return{provokers:[],cells:[]};let J=z.board.positions||{};for(let W=0;W<$.length-1;W++){let U=$[W];for(let[F,R]of Object.entries(J)){if(F===X)continue;if(w1(R,U)<=q)Z.add(F),K.push(M(U))}}return{provokers:Array.from(Z),cells:K}};var fz=()=>({allowAllyPassThrough:!0,difficult:new Set,blockers:new Set,board:{w:0,h:0}}),k1=(z,X)=>X.has(z),gz=(z,X)=>X.has(z),A1=(z,X)=>gz(z,X)?2:1;var uz=(z,X,$)=>{if(!X||!$)return!1;let Y=z.actors&&z.actors[X]||{},q=z.actors&&z.actors[$]||{};if(Y.team&&q.team)return Y.team!==q.team;return!1},S1=(z,X,$,Y={})=>{let q={...fz(),...Y,difficult:new Set(z.board.difficult||[]),blockers:new Set(z.board.blockers||[]),board:z.board};if(!z0(X,q.board)||!z0($,q.board))return null;let Z=M(X),K=M($);if(k1(K,q.blockers))return null;let J=new Map([[Z,0]]),W=new Map,U=new Map([[Z,0]]),F=(N,L)=>Math.max(Math.abs(N.x-L.x),Math.abs(N.y-L.y)),R=()=>{let N=null,L=1/0;for(let[D]of J){let[Q,H]=D.split(","),T={x:Number(Q),y:Number(H)},B=U.get(D)??1/0,C=F(T,$),E=B+C;if(E<L)L=E,N=D}return N};while(J.size>0){let N=R(),[L,D]=N.split(",").map(Number),Q={x:L,y:D};if(N===K){let H=[],T=N;while(T){let[C,E]=T.split(",").map(Number);H.push({x:C,y:E}),T=W.get(T)}H.reverse();let B=0;for(let C=1;C<H.length;C++)B+=A1(M(H[C]),q.difficult);return{path:H,cost:B}}J.delete(N);for(let H of u0(Q)){if(!z0(H,q.board))continue;let T=M(H);if(k1(T,q.blockers))continue;let B=E1(z,H),C=T===K;if(B){if(q.moverId&&uz(z,q.moverId,B))continue;if(C)continue;if(!q.allowAllyPassThrough)continue}let E=(U.get(N)??1/0)+A1(T,q.difficult),f=U.get(T);if(f===void 0||E<f)W.set(T,N),U.set(T,E),J.set(T,E)}}return null};var M1=(z=42)=>{return{matchId:`match_${Date.now()}_${z}`,rng:{seed:z,cursor:0},round:1,turn:{order:[],index:0},actions:{standard:1,move:1,minor:1,free:"unbounded",immediateUsedThisRound:!1},actors:{},board:{w:20,h:20,blockers:[],difficult:[],positions:{}},effects:{},queue:[],flags:{usage:{}},prompts:{current:null},log:[],_ts:0}},b1=(z)=>{let X=[];if(z.turn.order.length>0){let Y=z.turn.order[z.turn.index],q=lz(z,Y);X.push(...q)}let $=(z.turn.index+1)%Math.max(z.turn.order.length,1);if(X.push({type:"set",path:"turn.index",value:$}),$===0&&z.turn.order.length>0){X.push({type:"inc",path:"round",value:1});for(let q of z.turn.order)X.push({type:"merge",path:`flags.usage.${q}`,value:{immediateUsedThisRound:!1}});X.push({type:"log",value:{type:"round-begin",msg:`Round ${z.round+1} begins`}});let Y=Iz(z);X.push(...Y)}if(z.turn.order.length>0){let Y=z.turn.order[$],q=Gz(z,Y);X.push(...q)}return X},Iz=(z)=>{return[]},Gz=(z,X)=>{let $=[],Y=X,q=Array.isArray(z.queue)?[...z.queue]:[];while(q.length>0){let Z=q.shift();if(Z.type==="delay"&&Z.actorId){if(Z.actorId!==X){Y=Z.actorId;let K=z.turn.order.indexOf(Y);if(K>=0)$.push({type:"set",path:"turn.index",value:K})}$.push({type:"remove",path:"queue",value:Z}),$.push({type:"log",value:{type:"delay-resolve",actorId:Z.actorId,msg:`${Z.actorId} ends delay and acts now`}});break}if(Z.type==="ready"&&Z.actorId){$.push({type:"remove",path:"queue",value:Z}),$.push({type:"log",value:{type:"ready-resolve",actorId:Z.actorId,msg:`${Z.actorId}'s readied action resolves`}});continue}break}$.push(...j1(z,Y)),$.push({type:"merge",path:`flags.usage.${Y}`,value:{opportunityUsedThisTurn:!1}});for(let[Z,K]of Object.entries(z.effects||{})){let J=K.duration,W=J==="untilStartOfTurn"&&(K.target===Y||K.owner===Y),U=J&&J.kind==="untilStartOfTurn"&&J.actorId===Y;if(W||U)$.push({type:"set",path:`effects.${Z}`,value:void 0}),$.push({type:"log",value:{type:"effect-expire",msg:`Effect ${Z} ends at start of ${Y}'s turn`}})}if($.push({type:"set",path:"actions",value:{standard:1,move:1,minor:1,free:"unbounded",immediateUsedThisRound:!1}}),Y&&z.actors[Y]){let Z=D1(z,Y);$.push({type:"set",path:"actions",value:{standard:Z.standard,move:Z.move,minor:Z.minor,free:"unbounded",immediateUsedThisRound:!1}}),$.push({type:"log",value:{type:"turn-begin",actorId:Y,msg:`${Y}'s turn begins`}})}return $},lz=(z,X)=>{let $=[],Y=iz(z,X);$.push(...Y),$.push(...O1(z,X));let q=z.actors&&z.actors[X],Z=q&&q.flags&&q.flags.dying,K=q&&q.death&&q.death.stabilized;if(Z&&!K){let J=C1(z,X);$.push(...J.patches)}for(let[J,W]of Object.entries(z.effects||{})){let U=W.duration,F=U==="untilEndOfTurn"&&(W.target===X||W.owner===X),R=U&&U.kind==="untilEndOfTurn"&&U.actorId===X;if(F||R)$.push({type:"set",path:`effects.${J}`,value:void 0}),$.push({type:"log",value:{type:"effect-expire",msg:`Effect ${J} ends at end of ${X}'s turn`}})}return $.push({type:"log",value:{type:"turn-end",actorId:X,msg:`${X}'s turn ends`}}),$},iz=(z,X)=>{let $=[];for(let[Y,q]of Object.entries(z.effects))if(q.target===X&&q.duration==="saveEnds"){let{result:Z,patches:K}=l(z,"d20"),J=Z>=10;if($.push(...K||[]),$.push({type:"log",value:{type:"save",actorId:X,msg:`${X} saves vs ${q.condition} (${Z})`,data:{effect:q.condition,result:Z,success:J}}}),J)$.push({type:"set",path:`effects.${Y}`,value:void 0})}return $},pz=(z,X)=>{let $=z.actions;if(X==="standard"&&$.standard>0)return{ok:!0};if(X==="move"){if($.move>0)return{ok:!0};if($.standard>0)return{ok:!0,swap:{from:"standard",to:"move"}};return{ok:!1,reason:"No move or standard action available"}}if(X==="minor"){if($.minor>0)return{ok:!0};if($.move>0)return{ok:!0,swap:{from:"move",to:"minor"}};if($.standard>0)return{ok:!0,swap:{from:"standard",to:"minor"}};return{ok:!1,reason:"No minor, move, or standard action available"}}if(X==="free")return{ok:!0};return{ok:!1,reason:`No ${X} action available`}},P1=(z,X)=>{let{ok:$,reason:Y,swap:q}=pz(z,X);if(!$)return[{type:"log",value:{type:"info",msg:`Warning: ${Y}`}}];let Z=[];if(X==="standard")Z.push({type:"inc",path:"actions.standard",value:-1});else if(X==="move")if(q&&q.from==="standard")Z.push({type:"inc",path:"actions.standard",value:-1});else Z.push({type:"inc",path:"actions.move",value:-1});else if(X==="minor")if(q&&q.from==="move")Z.push({type:"inc",path:"actions.move",value:-1});else if(q&&q.from==="standard")Z.push({type:"inc",path:"actions.standard",value:-1});else Z.push({type:"inc",path:"actions.minor",value:-1});return Z.push({type:"log",value:{type:"info",msg:q?`Spent ${q.from} as ${X}`:`Spent ${X} action`}}),Z},y1=(z,X)=>0,x1=(z,X)=>{let{playOrderPos:$,playOrder:Y}=X;return($+1)%Y.length},h1=(z,X)=>!z.prompts.current;var m1=(z,X,$,Y="walk",q={})=>{let Z=z.board.positions[X];if(!Z)return{ok:!1,reason:"no-position"};let K=z.actors[X]&&z.actors[X].speed||6,J=Y==="run"?q.speedBonus??2:0,W=v0(z,X);if(W.speed0){if(Y==="shift"||Y==="walk"||Y==="run")return{ok:!1,reason:"speed0"}}let U=K+J;if(W.slowCap2)U=Math.min(U,2);if(Y==="shift"){let L=Math.abs($.x-Z.x),D=Math.abs($.y-Z.y);if(Math.max(L,D)!==1)return{ok:!1,reason:"shift-distance"};if(W.cannotShift)return{ok:!1,reason:"cannot-shift"};let Q=M($);if((z.board.difficult||[]).includes(Q))return{ok:!1,reason:"difficult"}}let F=S1(z,Z,$);if(!F)return{ok:!1,reason:"blocked"};if(Y==="shift"&&F.path.length!==2)return{ok:!1,reason:"shift-path"};let R=[];if(F.cost>U)R.push({type:"range",cost:F.cost,max:U});let N=_1(z,X,F.path);if(N.provokers.length>0&&Y!=="shift")R.push({type:"oa",provokers:N.provokers,cells:N.cells});return{ok:!0,path:F.path,cost:F.cost,warns:R}},v1=(z,X,$)=>{if(!$||!$.ok)return[{type:"log",value:{type:"info",msg:"Invalid move commit"}}];let Y=$.path[$.path.length-1];return[{type:"set",path:`board.positions.${X}`,value:Y},{type:"inc",path:"actions.move",value:-1},{type:"log",value:{type:"move-commit",msg:`Moved ${X} to ${Y.x},${Y.y}`,data:{actorId:X,from:$.path[0],to:Y,path:$.path,cost:$.cost}}}]},f1=(z,X,$="walk")=>{if(!X||!X.path)return[{type:"log",value:{type:"move-preview",msg:`Preview invalid for ${z}`,data:{actorId:z,ok:!1}}}];return[{type:"log",value:{type:"move-preview",msg:`Preview ${$} for ${z}`,data:{actorId:z,mode:$,from:X.path[0],to:X.path[X.path.length-1],path:X.path,cost:X.cost,warns:X.warns||[]}}}]};var g1={name:"4e",setup:()=>{let z=M1(42);return m(z,[{type:"set",path:"turn.order",value:["A1","E1"]},{type:"set",path:"turn.index",value:0},{type:"set",path:"actions",value:{standard:1,move:1,minor:1,free:"unbounded",immediateUsedThisRound:!1}},{type:"set",path:"actors.A1",value:{team:"A",hp:{current:24,max:30,temp:0},surges:{remaining:7,value:7}}},{type:"set",path:"actors.E1",value:{team:"B",hp:{current:30,max:30,temp:0},surges:{remaining:0,value:0}}},{type:"set",path:"board.positions.A1",value:{x:2,y:2}},{type:"set",path:"board.positions.E1",value:{x:8,y:4}}]),z},turn:{order:{first:(z,X)=>y1(z,X),next:(z,X)=>x1(z,X)},onBegin:(z,X)=>{},onEnd:(z,X)=>{}},moves:{setInitiative:(z,X,$)=>{let Y=[{type:"set",path:"turn.order",value:$},{type:"set",path:"turn.index",value:0},{type:"log",value:{type:"info",msg:`Initiative set: ${$.join(", ")}`}}];m(z,Y)},moveToken:(z,X,$,Y,q)=>{let Z,K,J,W=()=>{try{let R=Y&&typeof Y==="object"?Object.keys(Y):null;console.log("moveToken raw args:",{aType:typeof $,bType:typeof Y,cType:typeof q,a:$,bKeys:R,c:q})}catch{}};if($&&typeof $==="object"&&$.actorId!=null){if(Z=$.actorId,$.toX!=null&&$.toY!=null)K={x:$.toX,y:$.toY};else if($.to&&typeof $.to==="object")K={x:$.to.x,y:$.to.y};J=$.mode||"walk"}else if(typeof $==="string"){if(Z=$,Y&&typeof Y==="object"){if(Y.x!=null&&Y.y!=null)K={x:Y.x,y:Y.y};else if(Y.toX!=null&&Y.toY!=null)K={x:Y.toX,y:Y.toY};else if(Array.isArray(Y)&&Y.length>=2)K={x:Y[0],y:Y[1]}}J=q||"walk"}else W();if(console.log("moveToken normalized:",{actorId:Z,toCell:K,mode:J}),!z.board)z.board={w:20,h:20,blockers:[],difficult:[],positions:{}};if(!z.board.positions)z.board.positions={};if(console.log("G.board:",z.board),console.log("G.board.positions:",z.board?.positions),!Z||!K)return console.error("Missing actorId or toCell in moveToken"),G;if(!z.board||!z.board.positions)return console.error("Missing board or board.positions in state"),G;let U=m1(z,Z,K,J);if(!U||!U.ok)return G;let F=[...f1(Z,U,J),...v1(z,Z,U)];m(z,F)},useSecondWind:(z,X,$)=>{let Y=g0(z,$);m(z,Y)},bootstrapDemo:(z,X)=>{console.log("bootstrapDemo called - starting..."),m(z,[{type:"set",path:"turn.order",value:["A1","E1"]},{type:"set",path:"turn.index",value:0},{type:"set",path:"actions",value:{standard:1,move:1,minor:1,free:"unbounded",immediateUsedThisRound:!1}},{type:"set",path:"actors.A1",value:{team:"A",hp:{current:24,max:30,temp:0},surges:{remaining:7,value:7}}},{type:"set",path:"actors.E1",value:{team:"B",hp:{current:30,max:30,temp:0},surges:{remaining:0,value:0}}},{type:"set",path:"board.positions.A1",value:{x:2,y:2}},{type:"set",path:"board.positions.E1",value:{x:8,y:4}},{type:"log",value:{type:"info",msg:"Demo actors bootstrapped"}}]),console.log("bootstrapDemo completed successfully")},endTurn:(z,X)=>{if(!h1(z,X))return G;let $=b1(z);m(z,$),X.events.endTurn()},spendAction:(z,X,$)=>{let Y=P1(z,$);m(z,Y)},applyManualPatch:(z,X,$)=>{if(!$||typeof $!=="object"){console.warn("Invalid patch received:",$);return}if($.type==="set"){let Y=$.path.split("."),q=z;for(let Z=0;Z<Y.length-1;Z++){let K=Y[Z];q[K]=q[K]??{},q=q[K]}q[Y[Y.length-1]]=$.value}}}};var sz=(z,X)=>Math.max(Math.abs(z.x-X.x),Math.abs(z.y-X.y)),oz=(z)=>[{x:z.x+1,y:z.y},{x:z.x-1,y:z.y},{x:z.x,y:z.y+1},{x:z.x,y:z.y-1},{x:z.x+1,y:z.y+1},{x:z.x-1,y:z.y+1},{x:z.x+1,y:z.y-1},{x:z.x-1,y:z.y-1}],n=({x:z,y:X})=>`${z},${X}`,I0=({x:z,y:X},{w:$,h:Y})=>z>=0&&X>=0&&z<$&&X<Y,cz=(z,X)=>{let $=n(X);for(let[Y,q]of Object.entries(z.board.positions||{}))if(n(q)===$)return Y;return null},u1=(z,X)=>X.has(z),nz=(z,X)=>X.has(z),I1=(z,X)=>nz(z,X)?2:1,G1=(z,X,$)=>{let Y=new Set(z.board.difficult||[]),q=new Set(z.board.blockers||[]);if(!I0(X,z.board)||!I0($,z.board))return null;let Z=n(X),K=n($);if(u1(K,q))return null;let J=new Map([[Z,0]]),W=new Map,U=new Map([[Z,0]]),F=()=>{let R=null,N=1/0;for(let[L]of J){let[D,Q]=L.split(","),H={x:Number(D),y:Number(Q)},B=(U.get(L)??1/0)+sz(H,$);if(B<N)N=B,R=L}return R};while(J.size>0){let R=F();if(!R)break;let[N,L]=R.split(",").map(Number),D={x:N,y:L};if(R===K){let Q=[],H=R;while(H){let[B,C]=H.split(",").map(Number);Q.push({x:B,y:C}),H=W.get(H)}Q.reverse();let T=0;for(let B=1;B<Q.length;B++)T+=I1(n(Q[B]),Y);return{path:Q,cost:T}}J.delete(R);for(let Q of oz(D)){if(!I0(Q,z.board))continue;let H=n(Q);if(u1(H,q))continue;if(cz(z,Q)&&H!==K)continue;let T=(U.get(R)??1/0)+I1(H,Y),B=U.get(H);if(B===void 0||T<B)W.set(H,R),U.set(H,T),J.set(H,T)}}return null};var G0={};d0(G0,{toId:()=>X0,inBounds:()=>N0,facingFromVector:()=>l1,cellsForBurst:()=>rz,cellsForBlast:()=>ez,FACINGS8:()=>z5});var X0=({x:z,y:X})=>`${z},${X}`,N0=({x:z,y:X},$)=>z>=0&&X>=0&&z<$.w&&X<$.h,rz=(z,X,$)=>{let Y=new Set;for(let q=-X;q<=X;q++)for(let Z=-X;Z<=X;Z++){let K={x:z.x+q,y:z.y+Z};if(Math.max(Math.abs(q),Math.abs(Z))<=X){if(!$||N0(K,$))Y.add(X0(K))}}return Y},l1=(z,X)=>{let $=Math.sign(z),Y=Math.sign(X);if($===0&&Y===0)return{x:1,y:0};if($!==0&&Y!==0)return{x:$,y:Y};return{x:$,y:Y}},tz=(z)=>({x:-z.y,y:z.x}),ez=(z,X,$,Y,q=!1)=>{let Z=new Set,K=l1(X.x,X.y),J=tz(K),W=Math.floor(($-1)/2);if(q)Z.add(X0(z));for(let U=1;U<=$;U++){for(let F=-W;F<=W;F++){let R={x:z.x+U*K.x+F*J.x,y:z.y+U*K.y+F*J.y};if(!Y||N0(R,Y))Z.add(X0(R))}if($%2===0){let F=-W-1,R={x:z.x+U*K.x+F*J.x,y:z.y+U*K.y+F*J.y};if(!Y||N0(R,Y))Z.add(X0(R))}}return Z},z5=[{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1}];var Y5=document.getElementById("stage"),l0=document.getElementById("log"),q5=document.getElementById("sel-actor"),Z5=document.getElementById("hp"),K5=document.getElementById("thp"),J5=document.getElementById("surges"),i1=document.getElementById("init"),W5=document.getElementById("cnt-standard"),U5=document.getElementById("cnt-move"),F5=document.getElementById("cnt-minor"),p1=document.getElementById("btn-end-turn"),N5=document.getElementById("btn-override"),R5=document.getElementById("btn-help"),B5=document.getElementById("prompt"),d1=document.getElementById("override"),L5=document.getElementById("override-json"),V5=document.getElementById("override-apply"),H5=document.getElementById("override-close"),s1=document.getElementById("help"),Q5=document.getElementById("help-close"),bX=document.getElementById("prompt-title"),PX=document.getElementById("prompt-body"),T5=document.getElementById("prompt-use"),j5=document.getElementById("prompt-skip"),a=null;function o1(){a=null,B5.style.display="none",p1.disabled=!1}T5.onclick=()=>{if(!a)return;x("oa-resolve",`OA used by ${a.provokers[0]} on ${a.moverId}`),o1()};j5.onclick=()=>{if(!a)return;x("oa-skip",`OA skipped by ${a.provokers.join(", ")}`),o1()};N5.onclick=()=>{d1.style.display="block"};H5.onclick=()=>{d1.style.display="none"};V5.onclick=()=>{try{let z=JSON.parse(L5.value||"{}");O&&O.moves&&O.moves.applyManualPatch&&O.moves.applyManualPatch(z),x("manual-override",`Applied ${z.type} ${z.path}`)}catch(z){x("error","Invalid JSON")}};R5.onclick=()=>{s1.style.display="block"};Q5.onclick=()=>{s1.style.display="none"};var O5=document.getElementById("btn-mode-move"),D5=document.getElementById("btn-mode-measure"),C5=document.getElementById("btn-second-wind"),y="move",_=null,v=null,i0=0,b=null,R0=null,V,O;async function w5(){let Y=(await(await fetch("/games/4e/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({numPlayers:1})})).json().catch(()=>({}))).matchID||"local",q=void 0;try{let Z=await fetch(`/games/4e/${Y}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerID:"0",playerName:"Player"})});if(!Z.ok){let K=await Z.text().catch(()=>"");console.warn("Join failed:",Z.status,K)}else q=(await Z.json().catch(()=>({}))).playerCredentials}catch(Z){console.warn("Join error:",Z)}return{matchID:Y,credentials:q}}async function E5(){let{matchID:z,credentials:X}=await w5();O=X5({game:g1,multiplayer:$5({server:window.location.origin}),matchID:z,playerID:"0",credentials:X,debug:!1}),O.start();let $=!1,Y=()=>{let q=O.store?.getState?.();if(q&&q.G)V=q.G,_5();if(!$&&q&&typeof q._stateID==="number"&&q._stateID===0&&q.G&&q.G.board&&q.G.board.positions&&Object.keys(q.G.board.positions).length>0)$=!0};Y(),O.store.subscribe(Y),window.__BGIO_READY__=()=>$}E5();var j=new V0(Y5);if(V&&V.board)j.drawGrid(V.board),j.drawTokens(V);function x(z,X){let $=document.createElement("div");$.className=`entry ${z}`;let Y=document.createElement("span");Y.className="icon",Y.textContent=z==="attack-roll"?"\uD83C\uDFB2":z==="damage-apply"?"\uD83D\uDCA5":z==="save"?"\uD83D\uDEE1":z==="manual-override"?"✏️":"•";let q=document.createElement("span");q.className="msg";let Z=V&&V._ts?V._ts+1:1;q.textContent=`[${Z}] ${X}`,$.appendChild(Y),$.appendChild(q),l0.appendChild($),l0.scrollTop=l0.scrollHeight}function p0(){if(!V||!V.turn||!Array.isArray(V.turn.order))return;i1.innerHTML="";let z=V.turn.order||[];z.forEach((R,N)=>{let L=document.createElement("button");if(L.className="btn",L.style.padding="3px 6px",L.style.marginRight="6px",L.textContent=R+(N===V.turn.index?" *":""),N===V.turn.index)L.style.background="#243049";L.onclick=()=>{_=R,p0()},i1.appendChild(L)});let X=Math.min(V.turn.index||0,Math.max(z.length-1,0)),$=_||(z.length?z[X]:null),Y=$&&V.actors&&V.actors[$]||{};q5.textContent=$||"—";let q=Y.hp||{current:0,max:0,temp:0};Z5.textContent=`${q.current}/${q.max}`,K5.textContent=`${q.temp}`;let Z=Y.surges||{remaining:0,value:0};J5.textContent=`${Z.remaining} (${Z.value})`;let K=V.actions||{standard:0,move:0,minor:0};W5.textContent=K.standard,U5.textContent=K.move,F5.textContent=K.minor;let J="powers",W=document.getElementById(J);if(!W)W=document.createElement("div"),W.id=J,document.getElementById("panel").appendChild(W);W.innerHTML="";let U=document.createElement("button");U.className="btn",U.style.marginRight="6px",U.textContent="MBA",U.onclick=()=>{R0="MBA",p("target"),x("info","Target mode for MBA")};let F=document.createElement("button");F.className="btn",F.textContent="Burst 1",F.onclick=()=>{R0="BURST1",p("target"),x("info","Target mode for Burst 1")},W.appendChild(U),W.appendChild(F)}function _5(){if(!V)return;j.drawGrid(V.board),j.drawTokens(V),p0()}function p(z){y=z,x("mode",`Mode: ${z}`)}O5.onclick=()=>p("move");D5.onclick=()=>p("measure");window.addEventListener("keydown",(z)=>{if(z.key.toLowerCase()==="t")p("target")});window.addEventListener("keydown",(z)=>{if(z.key.toLowerCase()==="m")p("move")});window.addEventListener("keydown",(z)=>{if(z.key.toLowerCase()==="g")p("measure")});C5.onclick=()=>{let z=_||V&&V.turn&&V.turn.order[V.turn.index];if(!z)return;O&&O.moves&&O.moves.useSecondWind&&O.moves.useSecondWind(z)};p1.onclick=()=>{O&&O.moves&&O.moves.endTurn&&O.moves.endTurn()};j.tokenLayer&&(j.tokenLayer.eventMode="static");j.tokenLayer&&j.tokenLayer.on("click",(z)=>{let X=z.target;if(X&&typeof X.name==="string"&&X.name.startsWith("token:"))_=X.name.slice(6),p0()});j.app.view.addEventListener("mousemove",(z)=>{if(!V||!V.board)return;if(!_)return;let X=j.app.view.getBoundingClientRect(),$={x:z.clientX-X.left,y:z.clientY-X.top},Y=j.worldToCell($);if(y==="move"){if(!(window.__BGIO_READY__&&window.__BGIO_READY__()))return;let{findPath:q}=window,Z=V.board.positions[_];if(!Z)return;let K=q(V,Z,Y);if(K&&K.path&&K.path.length>1)j.drawPathHighlight(K.path);else j.drawPathHighlight(null)}else if(y==="measure"){if(b)j.drawPathHighlight([b,Y])}});j.app.view.addEventListener("click",(z)=>{if(!V||!V.board)return;if(!_)return;if(y==="measure"){let q=j.app.view.getBoundingClientRect(),Z={x:z.clientX-q.left,y:z.clientY-q.top},K=j.worldToCell(Z);if(!b)b=K,j.drawPathHighlight([b,K]);else{let J=Math.max(Math.abs(K.x-b.x),Math.abs(K.y-b.y));x("measure",`${b.x},${b.y} → ${K.x},${K.y} = ${J}`),b=null,j.drawPathHighlight(null)}return}if(y!=="move"&&y!=="target")return;let X=j.app.view.getBoundingClientRect(),$={x:z.clientX-X.left,y:z.clientY-X.top},Y=j.worldToCell($);if(y==="move"){if(!(window.__BGIO_READY__&&window.__BGIO_READY__()))return;let{findPath:q}=window,Z=q(V,V.board.positions[_],Y);if(!Z){x("warn","Path blocked");return}let K=Z.path[Z.path.length-1];O&&O.moves&&O.moves.moveToken&&O.moves.moveToken({actorId:_,toX:K.x,toY:K.y,mode:"walk"}),x("move-commit",`${_} -> ${K.x},${K.y} (cost ${Z.cost})`),j.drawPathHighlight(null)}else if(y==="target"){let q=V.board.positions[_];if(!q)return;let{cellsForBurst:Z,cellsForBlast:K,FACINGS8:J}=window.__Templates__;if(R0==="BURST1"){let W=Y,U=Z(W,1,V.board);j.drawTemplateCells(U,V.board),v={template:"burst1",cells:U,center:W}}else if(R0==="MBA")if(Math.max(Math.abs(Y.x-q.x),Math.abs(Y.y-q.y))<=1){let U=new Set([`${Y.x},${Y.y}`]);j.drawTemplateCells(U,V.board),v={template:"single",cells:U,center:Y}}else j.drawTemplateCells(null,V.board),v=null;else j.drawTemplateCells(null,V.board),v=null}});window.addEventListener("keydown",(z)=>{if(z.key==="Enter"&&v&&_&&y==="move"){if(!(window.__BGIO_READY__&&window.__BGIO_READY__()))return;let X=v.path[v.path.length-1];O&&O.moves&&O.moves.moveToken&&O.moves.moveToken({actorId:_,toX:X.x,toY:X.y,mode:"walk"}),j.drawPathHighlight(null),v=null}if(z.key==="Escape")j.drawPathHighlight(null),v=null,b=null;if(y==="target"&&(z.key.toLowerCase()==="q"||z.key.toLowerCase()==="e")){let X=z.key.toLowerCase()==="q"?-1:1;i0=(i0+X+8)%8;let $=V.board.positions[_],{cellsForBlast:Y,FACINGS8:q}=window.__Templates__,Z=q[i0],K=Y($,Z,3,V.board);j.drawTemplateCells(K,V.board)}});window.findPath=G1;window.__Templates__=G0;
