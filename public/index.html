<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>4e VTT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body { margin: 0; padding: 0; height: 100%; background: #0f1115; color: #e6e6e6; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

      #app { display: grid; grid-template-columns: 1fr 320px; grid-template-rows: auto 1fr auto; height: 100%; }

      header { grid-column: 1 / span 2; padding: 8px 12px; border-bottom: 1px solid #1a1d25; display:flex; align-items:center; justify-content:space-between; }

      #stage { grid-column: 1; grid-row: 2; background: #1a1d25; position: relative; }

      #panel { grid-column: 2; grid-row: 2; background: #1a1d25; border-left: 1px solid #2d3748; padding: 16px; overflow-y: auto; }

      #log { grid-column: 1 / span 2; grid-row: 3; background: #1a1d25; border-top: 1px solid #2d3748; padding: 8px 12px; font-family: monospace; font-size: 12px; max-height: 120px; overflow-y: auto; }

      .status { display: flex; gap: 8px; align-items: center; font-size: 14px; }
      .status-item { padding: 4px 8px; background: #2d3748; border-radius: 4px; }
      .status-item.current { background: #3182ce; }
      .status-item.team-a { background: #38a169; }
      .status-item.team-b { background: #e53e3e; }

      .actions { display: flex; gap: 8px; margin-top: 12px; }
      button { 
        padding: 6px 10px; 
        background: #2d3748; 
        color: #e6e6e6; 
        border: 1px solid #4a5568; 
        border-radius: 3px; 
        cursor: pointer; 
        font-size: 13px; 
        transition: all 0.2s ease;
      }
      button:hover { 
        background: #4a5568; 
        border-color: #718096;
      }
      button:disabled { 
        background: #1a1d25; 
        color: #718096; 
        cursor: not-allowed; 
        border-color: #2d3748;
      }

      .mode { margin-top: 12px; }
      .mode button { 
        background: #2d3748; 
        border-color: #4a5568;
      }
      .mode button.active { 
        background: #3182ce; 
        border-color: #3182ce;
        color: white;
      }

      .session-info { margin-bottom: 16px; padding: 12px; background: #2d3748; border-radius: 4px; }
      .session-info h3 { margin: 0 0 8px 0; font-size: 16px; }
      .session-info input { width: 100%; padding: 6px; background: #1a1d25; border: 1px solid #4a5568; border-radius: 4px; color: white; margin-bottom: 8px; }
      .session-info button { width: 100%; }

      .firebase-status { position: fixed; top: 8px; right: 8px; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
      .firebase-status.connected { background: #38a169; }
      .firebase-status.disconnected { background: #e53e3e; }
    </style>
  </head>
  <body>
    <div id="app">
      <header>
        <div class="status">
          <div class="status-item current">Turn: <span id="current-turn">-</span></div>
          <div class="status-item team-a">Team A: <span id="team-a-actions">-</span></div>
          <div class="status-item team-b">Team B: <span id="team-b-actions">-</span></div>
        </div>
        <div class="status">
          <div class="status-item">Round: <span id="current-round">-</span></div>
        </div>
      </header>

      <div id="stage"></div>

      <div id="panel">
        <div class="session-info">
          <h3>Game Session</h3>
          <input type="text" id="session-id" placeholder="Session ID" value="default">
          <button id="create-session">Create New Session</button>
          <button id="join-session">Join Session</button>
        </div>

        <div class="actions">
          <button id="end-turn">End Turn</button>
          <button id="second-wind">Second Wind</button>
        </div>

        <div class="mode">
          <button id="mode-move" class="active">Move (M)</button>
          <button id="mode-measure">Measure (G)</button>
          <button id="mode-target">Target (T)</button>
        </div>

        <div id="preview-info" style="margin-top: 16px; padding: 12px; background: #2d3748; border-radius: 4px; display: none;">
          <h4>Preview</h4>
          <div id="preview-details"></div>
          <div style="margin-top: 8px;">
            <button id="commit-preview">Commit (Enter)</button>
            <button id="cancel-preview">Cancel (Esc)</button>
          </div>
        </div>
      </div>

      <div id="log"></div>
    </div>

    <div id="firebase-status" class="firebase-status disconnected">Firebase: Local Only</div>

    <!-- PIXI.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA23NUgigHUu8f-3CkQCzogM-iHKg5TG_g",
        authDomain: "foure-vtt.firebaseapp.com",
        projectId: "foure-vtt",
        storageBucket: "foure-vtt.firebasestorage.app",
        messagingSenderId: "1006635005126",
        appId: "1:1006635005126:web:8254af5e2686e7b78313c7",
        measurementId: "G-QBWFERVWQS"
      };

      // Firebase status indicator
      const firebaseStatus = document.getElementById('firebase-status');
      
      // Update Firebase status
      function updateFirebaseStatus(connected) {
        firebaseStatus.textContent = `Firebase: ${connected ? 'Connected' : 'Local Only'}`;
        firebaseStatus.className = `firebase-status ${connected ? 'connected' : 'disconnected'}`;
      }

      // Real-time listener for game state
      let unsubscribe = null;
      let currentSessionId = 'default';
      let firebaseAvailable = false;

      // Check if we should use Firebase (only in production or when explicitly enabled)
      const USE_FIREBASE_CLIENT = window.location.hostname !== 'localhost' && 
                                 window.location.hostname !== '127.0.0.1' ||
                                 localStorage.getItem('enableFirebase') === 'true';

      // Try to initialize Firebase only if needed
      let app, db;
      if (USE_FIREBASE_CLIENT) {
        try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          firebaseAvailable = true;
          console.log('Firebase client SDK initialized successfully');
        } catch (error) {
          console.warn('Firebase client SDK not available, running in local-only mode:', error);
          firebaseAvailable = false;
        }
      } else {
        console.log('Firebase client disabled for local development');
        firebaseAvailable = false;
      }

      function setupFirebaseListener(sessionId) {
        // Unsubscribe from previous listener
        if (unsubscribe) {
          unsubscribe();
        }

        currentSessionId = sessionId;
        
        if (!firebaseAvailable || !db) {
          console.log('Firebase not available, using local-only mode');
          updateFirebaseStatus(false);
          return;
        }

        const gameDoc = doc(db, 'games', sessionId);
        
        unsubscribe = onSnapshot(gameDoc, (doc) => {
          if (doc.exists()) {
            const data = doc.data();
            if (data.gameState) {
              console.log('Firebase update received:', data.gameState);
              updateFirebaseStatus(true);
              
              // Update the game state in the client
              if (window.updateGameState) {
                window.updateGameState(data.gameState);
              }
            }
          } else {
            console.log('No game document found for session:', sessionId);
            updateFirebaseStatus(false);
          }
        }, (error) => {
          console.error('Firebase listener error:', error);
          updateFirebaseStatus(false);
        });
      }

      // Session management
      const sessionIdInput = document.getElementById('session-id');
      const createSessionBtn = document.getElementById('create-session');
      const joinSessionBtn = document.getElementById('join-session');

      createSessionBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/sessions', { method: 'POST' });
          const data = await response.json();
          if (data.success) {
            sessionIdInput.value = data.sessionId;
            setupFirebaseListener(data.sessionId);
            console.log('Created new session:', data.sessionId);
          }
        } catch (error) {
          console.error('Error creating session:', error);
        }
      });

      joinSessionBtn.addEventListener('click', () => {
        const sessionId = sessionIdInput.value.trim();
        if (sessionId) {
          setupFirebaseListener(sessionId);
          console.log('Joined session:', sessionId);
        }
      });

      // Initialize with default session
      setupFirebaseListener('default');
      updateFirebaseStatus(firebaseAvailable);

      // Make Firebase functions available globally
      window.firebase = {
        setupFirebaseListener,
        updateFirebaseStatus,
        currentSessionId: () => currentSessionId,
        isAvailable: () => firebaseAvailable
      };
    </script>

    <script type="module" src="/simple-app.js"></script>
  </body>
</html>
