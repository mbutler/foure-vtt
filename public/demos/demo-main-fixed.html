<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>4e VTT - Fixed Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body { margin: 0; padding: 0; height: 100%; background: #0f1115; color: #e6e6e6; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
      #app { display: grid; grid-template-columns: 1fr 320px; grid-template-rows: auto 1fr auto; height: 100%; }
      header { grid-column: 1 / span 2; padding: 8px 12px; border-bottom: 1px solid #1a1d25; display:flex; align-items:center; justify-content:space-between; }
      .title { font-weight: 600; letter-spacing: .5px; }
      .actionbar { display:flex; gap:8px; align-items:center; }
      .slot { font-size:12px; padding:4px 8px; border:1px solid #2a2f3a; border-radius:6px; background:#151923; color:#cfd3da; }
      .slot.disabled { opacity:.5 }
      .slot .count { color:#8ba3c7; margin-left:6px }
      #stage { grid-row: 2; grid-column: 1; position: relative; overflow:hidden; background: #0b0d12; }
      #sidebar { grid-row: 2; grid-column: 2; border-left:1px solid #1a1d25; display:flex; flex-direction:column; }
      #panel { flex:1; padding:12px; overflow:auto; }
      #log { grid-column: 1 / span 2; grid-row: 3; border-top:1px solid #1a1d25; height: 120px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0b0d12; padding:8px 12px; }
      #logbar { grid-column: 1 / span 2; grid-row: 3; display:flex; gap:8px; align-items:center; padding:4px 8px; color:#98a1b3 }
      #log .entry { margin:2px 0; display:flex; gap:8px; align-items:center }
      #log .icon { width:16px; text-align:center }
      #log .msg { white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
      #log .roll .icon { color:#eccc68 }
      #log .attack-roll .icon { color:#eccc68 }
      #log .damage-apply .icon { color:#ff6b81 }
      #log .save .icon { color:#70a1ff }
      #log .info .icon { color:#a4b0be }
      .btn { background:#1a1f2b; color:#e6e6e6; border:1px solid #2a2f3a; border-radius:6px; padding:6px 10px; cursor:pointer; }
      .btn:disabled { opacity:.5; cursor:not-allowed }
      .row { display:flex; align-items:center; gap:8px; margin-bottom:8px }
      .muted { color:#98a1b3 }
      #prompt { position: fixed; right: 16px; bottom: 150px; background:#151923; border:1px solid #2a2f3a; border-radius:8px; padding:10px 12px; max-width: 360px; display:none; box-shadow: 0 6px 24px rgba(0,0,0,0.35); }
      #prompt .title { font-weight:600; margin-bottom:6px }
      #prompt .actions { margin-top:8px; display:flex; gap:8px; justify-content:flex-end }
      #override { position: fixed; left: 16px; bottom: 150px; background:#151923; border:1px solid #2a2f3a; border-radius:8px; padding:10px 12px; max-width: 420px; width: 420px; display:none; box-shadow: 0 6px 24px rgba(0,0,0,0.35); }
      #override textarea { width:100%; height:120px; background:#0b0d12; color:#e6e6e6; border:1px solid #2a2f3a; border-radius:6px; padding:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px }
      #override .row { justify-content:flex-end }
      #help { position: fixed; left: 50%; top: 15%; transform: translateX(-50%); background:#151923; border:1px solid #2a2f3a; border-radius:8px; padding:12px 14px; width: 520px; display:none; box-shadow: 0 6px 24px rgba(0,0,0,0.35); }
      #help .title { font-weight:600; margin-bottom:8px }
      #help ul { margin:6px 0 0 18px; padding:0 }
      #help .row { justify-content:flex-end; margin-top:10px }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
  </head>
  <body>
    <div id="app">
      <header>
        <div class="title">4e VTT - Fixed Demo</div>
        <div class="actionbar">
          <button id="btn-mode-move" class="btn">Move (M)</button>
          <button id="btn-mode-measure" class="btn">Measure (G)</button>
          <div class="slot" id="slot-standard">Std <span class="count" id="cnt-standard">1</span></div>
          <div class="slot" id="slot-move">Move <span class="count" id="cnt-move">1</span></div>
          <div class="slot" id="slot-minor">Minor <span class="count" id="cnt-minor">1</span></div>
          <button id="btn-end-turn" class="btn">End Turn (.)</button>
          <button id="btn-override" class="btn">Manual Override</button>
          <button id="btn-help" class="btn">Help</button>
        </div>
      </header>
      <div id="stage"></div>
      <aside id="sidebar">
        <div id="panel">
          <div class="row"><b>Initiative</b></div>
          <div id="init" class="muted" style="margin-bottom:12px"></div>
          <div class="row"><b>Selected</b> <span id="sel-actor" class="muted">â€”</span></div>
          <div class="row"><b>HP</b> <span id="hp" class="muted">â€”</span> â€¢ <b>THP</b> <span id="thp" class="muted">â€”</span></div>
          <div class="row"><b>Surges</b> <span id="surges" class="muted">â€”</span></div>
          <div class="row"><button id="btn-second-wind" class="btn">Second Wind</button></div>
        </div>
      </aside>
      <div id="log"></div>
    </div>
    <div id="prompt">
      <div class="title" id="prompt-title"></div>
      <div class="muted" id="prompt-body"></div>
      <div class="actions">
        <button class="btn" id="prompt-use">Use</button>
        <button class="btn" id="prompt-skip">Skip</button>
      </div>
    </div>
    <div id="override">
      <div class="title">Manual Override</div>
      <textarea id="override-json" placeholder='{"type":"set","path":"actors.A1.hp.current","value":15}'></textarea>
      <div class="row">
        <button class="btn" id="override-apply">Apply</button>
        <button class="btn" id="override-close">Close</button>
      </div>
    </div>
    <div id="help">
      <div class="title">Shortcuts</div>
      <ul>
        <li>M: Move mode</li>
        <li>G: Measure mode</li>
        <li>T: Target mode</li>
        <li>Q/E: Rotate blast facing</li>
        <li>Enter: Commit preview</li>
        <li>Esc: Cancel preview</li>
        <li>.: End Turn</li>
      </ul>
      <div class="row">
        <button class="btn" id="help-close">Close</button>
      </div>
    </div>
    <script type="module">
      import { PixiStage } from '/ui/stage.js'
      import * as Pathing from '/ui/pathing.js'
      import * as Templates from '/ui/templates.js'

      const elStage = document.getElementById('stage')
      const elLog = document.getElementById('log')
      const elSel = document.getElementById('sel-actor')
      const elHp = document.getElementById('hp')
      const elThp = document.getElementById('thp')
      const elSurges = document.getElementById('surges')
      const elInit = document.getElementById('init')
      const elStd = document.getElementById('cnt-standard')
      const elMov = document.getElementById('cnt-move')
      const elMin = document.getElementById('cnt-minor')
      const elEnd = document.getElementById('btn-end-turn')
      const btnOverride = document.getElementById('btn-override')
      const btnHelp = document.getElementById('btn-help')
      const elPrompt = document.getElementById('prompt')
      const elOverride = document.getElementById('override')
      const elOverrideJson = document.getElementById('override-json')
      const elOverrideApply = document.getElementById('override-apply')
      const elOverrideClose = document.getElementById('override-close')
      const elHelp = document.getElementById('help')
      const elHelpClose = document.getElementById('help-close')
      const elPromptTitle = document.getElementById('prompt-title')
      const elPromptBody = document.getElementById('prompt-body')
      const elPromptUse = document.getElementById('prompt-use')
      const elPromptSkip = document.getElementById('prompt-skip')

      let openPrompt = null

      function openOAPrompt(moverId, provokers) {
        openPrompt = { kind: 'OA', moverId, provokers }
        elPromptTitle.textContent = 'Opportunity Attack'
        elPromptBody.textContent = `${provokers.join(', ')} can OA ${moverId}`
        elPrompt.style.display = 'block'
        elEnd.disabled = true
      }
      function closePrompt() {
        openPrompt = null
        elPrompt.style.display = 'none'
        elEnd.disabled = false
      }
      elPromptUse.onclick = () => {
        if (!openPrompt) return
        appendLog('oa-resolve', `OA used by ${openPrompt.provokers[0]} on ${openPrompt.moverId}`)
        closePrompt()
      }
      elPromptSkip.onclick = () => {
        if (!openPrompt) return
        appendLog('oa-skip', `OA skipped by ${openPrompt.provokers.join(', ')}`)
        closePrompt()
      }

      btnOverride.onclick = () => {
        elOverride.style.display = 'block'
      }
      elOverrideClose.onclick = () => { elOverride.style.display = 'none' }
      elOverrideApply.onclick = () => {
        try {
          const patch = JSON.parse(elOverrideJson.value || '{}')
          // minimal patch applier for demo
          const setAtPath = (obj, path, value) => { const keys = path.split('.'); let ref = obj; for (let i=0;i<keys.length-1;i++){ const k=keys[i]; ref = ref[k] ?? {}; ref = ref[k] } ref[keys[keys.length-1]] = value }
          if (patch && patch.type === 'set' && patch.path) { setAtPath(G, patch.path, patch.value) }
          appendLog('manual-override', `Applied ${patch.type} ${patch.path}`)
          renderPanel(); updateTokens()
        } catch (e) { appendLog('error', `Invalid JSON`) }
      }

      btnHelp.onclick = () => { elHelp.style.display = 'block' }
      elHelpClose.onclick = () => { elHelp.style.display = 'none' }
      const btnMove = document.getElementById('btn-mode-move')
      const btnMeasure = document.getElementById('btn-mode-measure')
      const btnSecondWind = document.getElementById('btn-second-wind')

      let mode = 'move' // 'move' | 'measure' | 'target'
      let selected = null
      let preview = null
      let facingIdx = 0
      let measureStart = null
      let currentPower = null // 'MBA' | 'BURST1' | 'BLAST3'

      let G = {
        board: { w: 15, h: 10, blockers: [], difficult: [], positions: {} },
        actors: {},
        turn: { order: [], index: 0 },
        actions: { standard: 1, move: 1, minor: 1 },
        log: [],
        _ts: 0
      }

      let matchID = null

      async function createMatch() {
        try {
          const res = await fetch('/games/4e/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ numPlayers: 1 })
          })
          const data = await res.json()
          matchID = data.matchID
          return matchID
        } catch (error) {
          console.error('Error creating match:', error)
          return null
        }
      }

      async function bootstrapDemo() {
        if (!matchID) {
          await createMatch()
        }
        
        try {
          const res = await fetch(`/games/4e/${matchID}/moves/bootstrapDemo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          })
          const data = await res.json()
          console.log('Bootstrap result:', data)
          
          // Set up demo data
          G = {
            board: { 
              w: 15, 
              h: 10, 
              blockers: ['5,5', '6,5', '7,5'], 
              difficult: ['3,3', '4,3', '5,3'], 
              positions: {
                'A1': { x: 2, y: 2 },
                'A2': { x: 3, y: 2 },
                'E1': { x: 8, y: 4 },
                'E2': { x: 9, y: 4 }
              }
            },
            actors: {
              'A1': { team: 'A', hp: { current: 24, max: 30, temp: 0 } },
              'A2': { team: 'A', hp: { current: 28, max: 30, temp: 0 } },
              'E1': { team: 'B', hp: { current: 30, max: 30, temp: 0 } },
              'E2': { team: 'B', hp: { current: 25, max: 30, temp: 0 } }
            },
            turn: { order: ['A1', 'A2', 'E1', 'E2'], index: 0 },
            actions: { standard: 1, move: 1, minor: 1 },
            log: [],
            _ts: 0
          }
          renderAll()
          appendLog('info', 'Demo data loaded')
        } catch (error) {
          console.error('Error bootstrapping:', error)
          appendLog('error', 'Failed to bootstrap demo')
        }
      }

      const stage = new PixiStage(elStage)

      function appendLog(type, msg){
        const div = document.createElement('div')
        div.className = `entry ${type}`
        const icon = document.createElement('span')
        icon.className = 'icon'
        icon.textContent = type === 'attack-roll' ? 'ðŸŽ²' : type === 'damage-apply' ? 'ðŸ’¥' : type === 'save' ? 'ðŸ›¡' : type === 'manual-override' ? 'âœï¸' : 'â€¢'
        const msgEl = document.createElement('span')
        msgEl.className = 'msg'
        const ts = ((G && G._ts) ? (G._ts + 1) : 1)
        msgEl.textContent = `[${ts}] ${msg}`
        div.appendChild(icon)
        div.appendChild(msgEl)
        elLog.appendChild(div)
        elLog.scrollTop = elLog.scrollHeight
      }

      function renderPanel(){
        if (!G || !G.turn || !Array.isArray(G.turn.order)) return
        // initiative list
        elInit.innerHTML = ''
        const order = G.turn.order || []
        order.forEach((id, idx) => {
          const btn = document.createElement('button')
          btn.className = 'btn'
          btn.style.padding = '3px 6px'
          btn.style.marginRight = '6px'
          btn.textContent = id + (idx === G.turn.index ? ' *' : '')
          if (idx === G.turn.index) btn.style.background = '#243049'
          btn.onclick = () => { selected = id; renderPanel() }
          elInit.appendChild(btn)
        })
        const idx = Math.min(G.turn.index || 0, Math.max(order.length - 1, 0))
        const id = selected || (order.length ? order[idx] : null)
        const actor = (id && G.actors && G.actors[id]) || {}
        elSel.textContent = id || 'â€”'
        const hp = actor.hp || { current:0, max:0, temp:0 }
        elHp.textContent = `${hp.current}/${hp.max}`
        elThp.textContent = `${hp.temp}`
        const surges = actor.surges || { remaining:0, value:0 }
        elSurges.textContent = `${surges.remaining} (${surges.value})`
        const actions = G.actions || { standard:0, move:0, minor:0 }
        elStd.textContent = actions.standard
        elMov.textContent = actions.move
        elMin.textContent = actions.minor
        // simple powers list
        const powersDivId = 'powers'
        let powersDiv = document.getElementById(powersDivId)
        if (!powersDiv) { powersDiv = document.createElement('div'); powersDiv.id = powersDivId; document.getElementById('panel').appendChild(powersDiv) }
        powersDiv.innerHTML = ''
        const p1 = document.createElement('button'); p1.className = 'btn'; p1.style.marginRight = '6px'; p1.textContent = 'MBA'; p1.onclick = () => { currentPower = 'MBA'; setMode('target'); appendLog('info', 'Target mode for MBA') }
        const p2 = document.createElement('button'); p2.className = 'btn'; p2.textContent = 'Burst 1'; p2.onclick = () => { currentPower = 'BURST1'; setMode('target'); appendLog('info', 'Target mode for Burst 1') }
        powersDiv.appendChild(p1); powersDiv.appendChild(p2)
      }

      function renderAll(){
        if (!G) return
        stage.drawGrid(G.board)
        stage.drawTokens(G)
        renderPanel()
      }

      function updateTokens(){ stage.drawTokens(G) }

      function setMode(m){ mode = m; appendLog('mode', `Mode: ${m}`) }

      btnMove.onclick = () => setMode('move')
      btnMeasure.onclick = () => setMode('measure')
      // Temporary: press T to enter target mode
      window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 't') setMode('target') })
      window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'm') setMode('move') })
      window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'g') setMode('measure') })
      btnSecondWind.onclick = () => {
        const id = selected || (G && G.turn && G.turn.order[G.turn.index])
        if (!id) return
        appendLog('info', `${id} uses Second Wind`)
      }

      elEnd.onclick = () => {
        // End turn: log end, advance index, reset actions, log begin, select new actor
        const actor = G.turn.order[G.turn.index]
        appendLog('turn-end', `${actor} ends turn`)
        G.turn.index = (G.turn.index + 1) % Math.max(G.turn.order.length, 1)
        G.actions = { standard: 1, move: 1, minor: 1, free: 'unbounded', immediateUsedThisRound: false }
        const next = G.turn.order[G.turn.index]
        selected = next
        appendLog('turn-begin', `${next} begins turn`)
        renderPanel()
      }

      // Click to select token
      stage.tokenLayer && (stage.tokenLayer.eventMode = 'static')
      stage.tokenLayer && stage.tokenLayer.on('click', (e) => {
        const tgt = e.target
        if (tgt && typeof tgt.name === 'string' && tgt.name.startsWith('token:')) {
          selected = tgt.name.slice('token:'.length)
          renderPanel()
        }
      })

      // Move/Measure previews: hover shows path; click commits (move) or sets endpoints (measure)
      stage.app.view.addEventListener('mousemove', (e) => {
        if (!G || !G.board) return
        if (!selected) return
        const rect = stage.app.view.getBoundingClientRect()
        const pt = { x: e.clientX - rect.left, y: e.clientY - rect.top }
        const cell = stage.worldToCell(pt)
        if (mode === 'move') {
          const from = G.board.positions[selected]
          if (!from) return
          const res = Pathing.findPath(G, from, cell)
          if (res && res.path && res.path.length > 1) stage.drawPathHighlight(res.path)
          else stage.drawPathHighlight(null)
        } else if (mode === 'measure') {
          if (measureStart) {
            stage.drawPathHighlight([measureStart, cell])
          }
        }
      })

      // Move/Measure previews on left click
      stage.app.view.addEventListener('click', (e) => {
        if (!G || !G.board) return
        if (!selected) return
        if (mode === 'measure') {
          const rect = stage.app.view.getBoundingClientRect()
          const pt = { x: e.clientX - rect.left, y: e.clientY - rect.top }
          const cell = stage.worldToCell(pt)
          if (!measureStart) {
            measureStart = cell
            stage.drawPathHighlight([measureStart, cell])
          } else {
            const dist = Math.max(Math.abs(cell.x - measureStart.x), Math.abs(cell.y - measureStart.y))
            appendLog('measure', `${measureStart.x},${measureStart.y} â†’ ${cell.x},${cell.y} = ${dist}`)
            measureStart = null
            stage.drawPathHighlight(null)
          }
          return
        }
        if (mode !== 'move' && mode !== 'target') return
        const rect = stage.app.view.getBoundingClientRect()
        const pt = { x: e.clientX - rect.left, y: e.clientY - rect.top }
        const cell = stage.worldToCell(pt)
        if (mode === 'move') {
          const res = Pathing.findPath(G, G.board.positions[selected], cell)
          if (!res) { appendLog('warn', 'Path blocked'); return }
          // commit immediately for simplicity
          const to = res.path[res.path.length - 1]
          G.board.positions[selected] = to
          appendLog('move-commit', `${selected} -> ${to.x},${to.y} (cost ${res.cost})`)
          stage.drawPathHighlight(null)
          renderAll()
        } else if (mode === 'target') {
          const attacker = G.board.positions[selected]
          if (!attacker) return
          if (currentPower === 'BURST1') {
            const center = cell
            const burst = Templates.cellsForBurst(center, 1, G.board)
            stage.drawTemplateCells(burst, G.board)
            preview = { template: 'burst1', cells: burst, center }
          } else if (currentPower === 'MBA') {
            // Melee basic: single target within 1 of attacker -> highlight only that target cell
            const dx = Math.max(Math.abs(cell.x - attacker.x), Math.abs(cell.y - attacker.y))
            if (dx <= 1) {
              const ids = new Set([`${cell.x},${cell.y}`])
              stage.drawTemplateCells(ids, G.board)
              preview = { template: 'single', cells: ids, center: cell }
            } else {
              stage.drawTemplateCells(null, G.board)
              preview = null
            }
          } else {
            // default: no template
            stage.drawTemplateCells(null, G.board)
            preview = null
          }
        }
      })

      // Confirm move with Enter
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && preview && selected && mode === 'move') {
          const to = preview.path[preview.path.length - 1]
          G.board.positions[selected] = to
          appendLog('move-commit', `${selected} -> ${to.x},${to.y} (cost ${preview.cost})`)
          stage.drawPathHighlight(null)
          updateTokens()
          preview = null
        }
        if (e.key === 'Escape') {
          stage.drawPathHighlight(null)
          preview = null
          measureStart = null
        }
        if (mode === 'target' && (e.key.toLowerCase() === 'q' || e.key.toLowerCase() === 'e')) {
          const dir = e.key.toLowerCase() === 'q' ? -1 : 1
          facingIdx = (facingIdx + dir + 8) % 8
          // Redraw a blast from attacker with new facing for preview
          const attacker = G.board.positions[selected]
          const facing = Templates.FACINGS8[facingIdx]
          const cells = Templates.cellsForBlast(attacker, facing, 3, G.board)
          stage.drawTemplateCells(cells, G.board)
        }
      })

      // Initialize
      createMatch().then(() => {
        bootstrapDemo()
      })

      // Initial render
      renderAll()
    </script>
  </body>
  </html>
