<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Test Moves</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
    </style>
  </head>
  <body>
    <h1>Test Moves</h1>
    <button id="create-game">Create Game</button>
    <button id="bootstrap">Bootstrap Demo</button>
    <button id="manual-patch">Manual Patch Test</button>
    <button id="check-state">Check State</button>
    <div id="log" class="log"></div>

    <script type="module">
      const logDiv = document.getElementById('log')
      let client = null
      let matchID = null

      function log(message) {
        logDiv.innerHTML += message + '<br>'
        console.log(message)
      }

      async function createGame() {
        try {
          const response = await fetch('/games/4e/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ numPlayers: 1 })
          })
          const data = await response.json()
          matchID = data.matchID
          log(`Created game: ${matchID}`)
          
          // Start client
          const { Client } = await import('https://esm.sh/boardgame.io@0.50.2/client')
          const { SocketIO } = await import('https://esm.sh/boardgame.io@0.50.2/multiplayer')
          
          client = Client({
            game: {
              name: '4e',
              setup: () => ({ /* setup handled by server */ }),
              moves: {
                setInitiative: (G, ctx, order) => {},
                moveToken: (G, ctx, actorId, toCell, mode = 'walk') => {},
                useSecondWind: (G, ctx, actorId) => {},
                bootstrapDemo: (G, ctx) => {},
                endTurn: (G, ctx) => {},
                spendAction: (G, ctx, kind) => {},
                applyManualPatch: (G, ctx, patch) => {}
              }
            },
            multiplayer: SocketIO({ server: window.location.origin }),
            matchID,
            playerID: '0',
            debug: false
          })

          client.subscribe((state) => {
            if (state && state.G) {
              log(`State update: actors=${Object.keys(state.G.actors || {}).length}`)
              if (state.G.actors && Object.keys(state.G.actors).length > 0) {
                log(`Actors: ${JSON.stringify(state.G.actors)}`)
              }
              // Check if log entries are being added
              if (state.G.log && state.G.log.length > 0) {
                log(`Log entries: ${state.G.log.length}`)
                const lastLog = state.G.log[state.G.log.length - 1]
                log(`Last log: ${JSON.stringify(lastLog)}`)
              }
            }
          })

          client.start()
          log('Client started')
        } catch (error) {
          log(`Error: ${error.message}`)
        }
      }

      async function bootstrap() {
        if (!client) {
          log('No client available')
          return
        }
        try {
          log('Calling bootstrapDemo...')
          client.moves.bootstrapDemo()
          log('bootstrapDemo called')
        } catch (error) {
          log(`Bootstrap error: ${error.message}`)
        }
      }

      async function manualPatch() {
        if (!client) {
          log('No client available')
          return
        }
        try {
          log('Applying manual patch...')
          client.moves.applyManualPatch({ type: 'set', path: 'actors.A1', value: { team: 'A', hp: { current: 24, max: 30, temp: 0 }, surges: { remaining: 7, value: 7 } } })
          log('Manual patch applied')
        } catch (error) {
          log(`Manual patch error: ${error.message}`)
        }
      }

      async function checkState() {
        if (!client) {
          log('No client available')
          return
        }
        try {
          const state = client.getState()
          if (state && state.G) {
            log(`Current state: actors=${Object.keys(state.G.actors || {}).length}`)
            log(`Board: ${JSON.stringify(state.G.board)}`)
            if (state.G.actors) {
              log(`Actors: ${JSON.stringify(state.G.actors)}`)
            }
          } else {
            log('No state available')
          }
        } catch (error) {
          log(`Check state error: ${error.message}`)
        }
      }

      document.getElementById('create-game').onclick = createGame
      document.getElementById('bootstrap').onclick = bootstrap
      document.getElementById('manual-patch').onclick = manualPatch
      document.getElementById('check-state').onclick = checkState
    </script>
  </body>
</html>
